{% extends 'base.html' %}

{#
  Parts listing for the warehouse.

  This page enumerates all mechanical parts stored in the system that are
  neither assemblies nor commercial items.  A tab bar at the top
  mirrors the navigation on the main warehouse dashboard and highlights
  the current section.  Each part is displayed in a flat list using
  the same grid layout as the assembly tree headers: number, image
  placeholder, code, description, category, quantity on hand and an
  action button to load stock via the production module.

  If no parts exist a muted message is shown.  Quantities are
  recalculated before rendering by the blueprint.
#}

{% block title %}Magazzino – Parti{% endblock %}

{% block content %}
<section class="section">
  {# Back button to return to the previous page.  Uses the referrer URL
     if available, falling back to the warehouse index. #}
  {# Always return to the inventory overview instead of relying on the HTTP referrer. #}
  <a href="{{ url_for('inventory.index') }}" class="btn ghost small" style="margin-bottom:8px;">← Indietro</a>
  <h2 class="section-title">Magazzino: Parti</h2>
  {# Tab navigation reused from the main inventory page.  See
     inventory/index.html for details.  #}
  {# Provide full category navigation on the parts listing as well.  This allows
     users to switch between assemblies, parts, commercial components, products and
     history from this page. #}
  <div class="tab-links">
    <a href="{{ url_for('inventory.list_assemblies') }}"
       class="btn small{{ ' primary' if active_tab == 'assemblies' else ' ghost' }}">Assiemi</a>
    <a href="{{ url_for('inventory.list_parts') }}"
       class="btn small{{ ' primary' if active_tab == 'parts' else ' ghost' }}">Parti</a>
    <a href="{{ url_for('inventory.list_commercial') }}"
       class="btn small{{ ' primary' if active_tab == 'commercial' else ' ghost' }}">Commerciali</a>
    <a href="{{ url_for('inventory.index') }}"
       class="btn small{{ ' primary' if active_tab == 'products' else ' ghost' }}">Prodotti</a>
    {# Link to the production history (previously assembly archive).  This
       button displays "Storico produzione" and is highlighted when the
       archive tab is active. #}
    <a href="{{ url_for('inventory.archive') }}"
       class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Storico&nbsp;produzione</a>
  </div>

  {# Search bar to quickly filter the list of parts by code or description.  Center the input horizontally. #}
  <div style="margin-bottom:12px; display:flex; justify-content:center;">
    <input type="text" id="parts-search" class="input" placeholder="Cerca..." style="width:100%; max-width:400px; padding:8px; border-radius:8px; border:1px solid var(--glass-stroke);">
  </div>

  {% if parts|length == 0 %}
    <p class="muted">Nessuna parte definita.</p>
  {% else %}
    <div class="component-header">
      <div class="component-row">
        <div class="col-number">#</div>
        <div class="col-image">Img</div>
        <div class="col-code">Codice</div>
        <div class="col-desc">Descrizione</div>
        <div class="col-revision">Revisione</div>
        <div class="col-category">Categoria</div>
        <div class="col-qty">Stock</div>
        <div class="col-actions">Azioni</div>
      </div>
    </div>
    <div class="component-tree">
      {%- for part in parts %}
      {#
        Wrap each part row in a <details> element with the `component-node` class to
        mirror the layout used in the assemblies view.  The `data-leaf` attribute
        hides the arrow indicator for leaf nodes and provides a consistent card
        with border, radius and transparent background defined in CSS.  Placing
        the row inside a <summary> allows highlight and filtering logic to
        operate on the containing <details> element rather than the inner row.
      #}
      <details id="part-{{ part.id }}" class="component-node" data-leaf="true">
        <summary>
          <div class="component-row">
            <div class="col-number">{{ loop.index }}</div>
            <div class="col-image">
              {# Display the part's image if available via the computed display_image_filename; otherwise show a placeholder icon. #}
              {% if part.display_image_filename %}
                <img loading="lazy" src="{{ url_for('static', filename='uploads/' + part.display_image_filename) }}" alt="{{ part.name }}">
              {% else %}
                <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ part.name }}" style="max-width:100%; max-height:80px; object-fit:contain; filter: invert(1); opacity:0.7;">
              {% endif %}
            </div>
            <div class="col-code">{{ part.name }}</div>
            <div class="col-desc">{{ part.description or '—' }}</div>
            <div class="col-revision">{{ part.revision_label }}</div>
            <div class="col-category">Parte</div>
            <div class="col-qty">{{ (part.quantity_in_stock or 0)|int }}</div>
            <div class="col-actions">
              <a href="{{ url_for('inventory.load_component', part_id=part.id) }}" class="btn ghost small">Carica</a>
            </div>
          </div>
        </summary>
      </details>
      {%- endfor %}
    </div>
  {% endif %}

  <script>
  // Simple filter for the parts list.  When the user types in the search box
  // we iterate over each <details> element in the component tree and toggle
  // its display based on whether the contained row matches the query.
  document.addEventListener('DOMContentLoaded', function(){
    const input = document.getElementById('parts-search');
    if (!input) return;
    input.addEventListener('input', () => {
      const query = input.value.toLowerCase().trim();
      // Each part row is wrapped in a <details> element with class component-node
      const nodes = document.querySelectorAll('.component-tree details.component-node');
      nodes.forEach(node => {
        const text = node.textContent.toLowerCase();
        node.style.display = (query === '' || text.includes(query)) ? '' : 'none';
      });
    });
  });
  </script>

  {#
    Automatically scroll back to a part row after loading stock.
    When the page is loaded with a fragment like ``#part-42`` the
    corresponding row will be found, scrolled into view and briefly
    highlighted.  This prevents the view from resetting to the top of
    the list after a stock operation.  See ``production.routes.add_stock``
    for how the fragment is added.
  #}
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    const hash = window.location.hash;
    if (hash && hash.startsWith('#part-')) {
      const id = hash.substring(1);
      const target = document.getElementById(id);
      if (target) {
        // Scroll the containing node into view.
        try {
          target.scrollIntoView({behavior: 'smooth', block: 'center'});
        } catch (err) {
          target.scrollIntoView();
        }
        // Highlight the inner row rather than the <details> element itself.
        const row = target.querySelector('.component-row');
        const el = row || target;
        el.classList.add('highlight-row');
        setTimeout(() => {
          el.classList.remove('highlight-row');
        }, 2000);
      }
    }
  });
  </script>

</section>
{% endblock %}