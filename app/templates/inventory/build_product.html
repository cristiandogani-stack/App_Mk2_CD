{% extends 'base.html' %}

{#
  Guided procedure for constructing a finished product.

  This template mirrors the build_assembly interface: it lists all
  immediate child products (parts, assemblies or commercial items)
  required to assemble the selected product, shows their current stock
  levels, displays any existing documentation for both the product and
  its children and requires the operator to upload a compiled version
  for every existing document.  Each child card includes an "Associa"
  button that prompts for a DataMatrix scan; successful scans link
  the scanned component to the current build via the API.  A traffic
  light indicator at the top reflects readiness: it turns green only
  when all child components are in stock, each has been associated the
  required number of times and all required document uploads have a
  file selected.  The build button is enabled only when the indicator
  is green.  Operators may cancel the operation via the back link or
  by clicking "Annulla".
#}

{% block title %}Costruisci {{ product.name }} â€“ Magazzino{% endblock %}

{#
  When this build page is loaded inside an embedded modal (triggered via
  the ``embedded`` query parameter), hide the application header and
  navigation to minimise distractions and provide a clean popup.  Also
  intercept form submission: ask for confirmation before proceeding and
  schedule the closure of the modal after a short delay so that the
  backend has time to process the request.  These behaviours mirror
  those implemented in the assembly build template.
#}
{% if embedded %}
<style>
  /* Hide header and mobile navigation completely when embedded */
  .app-header, .nav-mobile { display:none !important; }
  /* Hide the back link at the top of the build page */
  .section > a.btn.ghost.small { display:none !important; }
</style>
<script>
// Embedded mode submission handling
document.addEventListener('DOMContentLoaded', function(){
  const form = document.querySelector('form');
  if (!form) return;
  form.addEventListener('submit', function(e){
    // Prompt the user before submitting
    const ok = confirm('Confermare la costruzione del prodotto?');
    if (!ok) {
      e.preventDefault();
      return;
    }
    // After submission, close the modal and refresh the parent page
    setTimeout(function(){
      if (window.parent) {
        try {
          const parentDoc = window.parent.document;
          const modal = parentDoc.getElementById('buildModal');
          const iframe = parentDoc.getElementById('buildFrame');
          if (iframe) iframe.src = '';
          if (modal) modal.style.display = 'none';
          // Refresh the parent page so that stock and box status update
          window.parent.location.reload();
        } catch(err) {
          console.error(err);
        }
      }
    }, 1000);
  });
});
</script>
{% endif %}

{% block content %}
<section class="section">
  <h2 class="section-title">Costruisci {{ product.name }}</h2>
  {# Back link: return to the referrer or fall back to the product detail page #}
  <a href="{{ back_url or url_for('inventory.product_detail', product_id=product.id) }}" class="btn ghost small" style="margin-bottom:12px;">Indietro</a>
  <div class="glass" style="padding:16px;">
    {# If no BOM exists show a muted message #}
    {% if children|length == 0 %}
      <p class="muted">Nessun BOM definito per questo prodotto.</p>
    {% else %}
      {# Build readiness and number of units buildable.  The traffic
         light indicates whether all parts are in stock, all scans are
         completed and all uploads have files selected.  The state is
         updated dynamically in the script below. #}
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
        <span style="font-size:20px;">UnitÃ  costruibili: {{ number_buildable }}</span>
        <span title="Documenti e componenti" style="font-size:24px;">{{ 'ðŸŸ¢' if ready_parts and docs_ready and assoc_ready else 'ðŸ”´' }}</span>
      </div>
      {# Start form: include all child cards, documentation and build controls inside the form so that
         file inputs are correctly submitted and monitored by the dynamic script. #}
      <form method="post" enctype="multipart/form-data" style="margin-top:0;">
        <input type="hidden" name="back_url" value="{{ back_url or url_for('inventory.product_detail', product_id=product.id) }}">
        {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        {# Child component cards.  Each card shows required/available
           quantities, the number of associated components and any
           existing documentation.  For each existing document a file
           input is rendered to capture the compiled version. #}
        <div class="grid grid-2" style="gap:16px;">
          {% for c in children %}
            {% set child = c.child %}
            <div class="card glass" style="padding:16px;">
              <div style="text-align:center; margin-bottom:8px;">
                {% if child.display_image_filename %}
                  <img loading="lazy" src="{{ url_for('static', filename='uploads/' + child.display_image_filename) }}" alt="{{ child.name }}" style="max-width:120px; max-height:120px; object-fit:contain; display:block; margin:0 auto;">
                {% elif child.image_filename %}
                  <img loading="lazy" src="{{ url_for('static', filename='uploads/' + child.image_filename) }}" alt="{{ child.name }}" style="max-width:120px; max-height:120px; object-fit:contain; display:block; margin:0 auto;">
                {% else %}
                  <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ child.name }}" style="max-width:120px; max-height:120px; object-fit:contain; display:block; margin:0 auto; filter: invert(1); opacity:0.7;">
                {% endif %}
              </div>
              <h4 style="text-align:center; margin:0 0 4px 0; font-size:18px; font-weight:600;">{{ child.name }}</h4>
              <p style="text-align:center; font-size:14px; color:var(--muted); margin:0 0 4px;">Richiesti: {{ required_quantities.get(child.id, 1) }}</p>
              <p style="text-align:center; font-size:14px; color:var(--muted); margin:0 0 4px;">Associati: {{ associated_counts.get(child.id, 0) }}</p>
              <p style="text-align:center; font-size:14px; color:var(--muted); margin:0 0 12px;">Disponibili: {{ child.quantity_in_stock or 0 }}</p>
              <div style="text-align:center; margin-bottom:12px;">
                <button type="button"
                        class="btn small primary associate"
                        data-part-id="{{ child.id }}"
                        data-part-name="{{ child.name }}"
                        data-required="{{ required_quantities.get(child.id, 1) }}"
                        data-associated="{{ associated_counts.get(child.id, 0) }}"
                        {% if (not assembly_code) or (associated_counts.get(child.id, 0) >= required_quantities.get(child.id, 1)) %}disabled{% endif %}>Associa</button>
              </div>
            </div>
          {% endfor %}
        </div>
        {# Product-level documentation section.  Show existing docs and
           upload fields below the component list. #}
        {% set prod_docs = doc_map.get(product.id) %}
        {% if prod_docs %}
          <div style="margin-top:24px;">
            <h5 style="margin:0 0 6px; font-size:14px; font-weight:600;">Documenti prodotto</h5>
            <div class="document-section">
              {# Iterate once per document category.  For each category, list all existing documents
                 with download links, then show a single file input for uploading the compiled
                 version.  This prevents duplicate file inputs when multiple source documents
                 exist in the same category. #}
              {% for folder_key, docs in prod_docs.items() %}
                {% if docs|length > 0 %}
                <div class="document-card">
                  <div class="document-card-header">
                    <span class="document-card-title">{{ doc_label_map.get(folder_key, folder_key) }}</span>
                    <div class="document-card-meta">
                      <div class="document-downloads">
                        {% for doc in docs %}
                        <div class="document-downloads-row">
                          <span style="font-size:14px;">{{ doc.display_name }}</span>
                          {% if doc.url %}
                            <a href="{{ doc.url }}" target="_blank" class="btn ghost small" style="white-space:nowrap;">Scarica</a>
                          {% else %}
                            <span class="muted" style="white-space:nowrap;">â€”</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                  <div class="document-card-body">
                    <input type="file" name="upload_{{ product.id }}_{{ folder_key }}_0" required>
                    <span class="file-name document-file-name"></span>
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}
        <div style="display:flex; gap:8px; margin-top:24px;">
          <button type="submit" class="btn primary" {% if not ready_all %}disabled{% endif %}>Costruisci</button>
          <a href="{{ back_url or url_for('inventory.product_detail', product_id=product.id) }}" class="btn ghost">Annulla</a>
        </div>
      </form>
    {% endif %}
  </div>
</section>
<script>
// Dynamic update of the traffic light and build button.  This script
// monitors all file inputs and recomputes readiness whenever a file
// changes.  It also references server-provided readiness flags for
// parts and associations.  When all conditions are satisfied the
// traffic light turns green and the build button is enabled.
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  if (!form) return;
  const fileInputs = form.querySelectorAll('input[type="file"]');
  const semSpan = document.querySelector('span[title="Documenti e componenti"]');
  const buildBtn = form.querySelector('button[type="submit"]');
  const readyParts = {{ ready_parts | tojson | safe }};
  const assocReady = {{ assoc_ready | tojson | safe }};
  let docsReadyInit = {{ docs_ready | tojson | safe }};
  function updateReady() {
    let docsOk = docsReadyInit;
    // When docs are not initially ready, ensure every file input has at least one file selected
    if (!docsOk) {
      docsOk = true;
      fileInputs.forEach(function(inp) {
        if (!inp.files || inp.files.length === 0) {
          docsOk = false;
        }
      });
    }
    const allReady = docsOk && readyParts && assocReady;
    if (semSpan) {
      semSpan.textContent = allReady ? 'ðŸŸ¢' : 'ðŸ”´';
    }
    if (buildBtn) {
      buildBtn.disabled = !allReady;
    }
  }
  fileInputs.forEach(function(inp) {
    inp.addEventListener('change', updateReady);
  });
  // Initial evaluation
  updateReady();
});
</script>
<script>
// Association workflow for linking scanned components to this product build.
// Each "Associa" button prompts for a DataMatrix code.  The scanned
// code and the assembly_code of this product are sent to the API.
// On success the page reloads to reflect updated association counts.
document.addEventListener('DOMContentLoaded', function() {
  const assemblyCode = {{ assembly_code | tojson | safe }};
  const associateButtons = document.querySelectorAll('.associate');
  associateButtons.forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!assemblyCode) {
        alert('Nessun codice prodotto disponibile. Apri la costruzione da una prenotazione con scatola.');
        return;
      }
      const partName = this.dataset.partName || '';
      const required = parseInt(this.dataset.required || '1');
      const associated = parseInt(this.dataset.associated || '0');
      if (associated >= required) {
        // Do not allow additional associations when requirement is met
        return;
      }
      const scanned = prompt('Scansiona il datamatrix del componente ' + partName + ':');
      if (!scanned) {
        return;
      }
      const trimmed = scanned.trim();
      // Extract P= segment to verify that the scanned component matches expected part
      let scannedPart = '';
      try {
        trimmed.split('|').forEach(function(seg) {
          if (seg.startsWith('P=')) {
            scannedPart = seg.substring(2);
          }
        });
      } catch(err) {
        scannedPart = '';
      }
      if (scannedPart && scannedPart.toLowerCase() !== partName.toLowerCase()) {
        alert('Hai scansionato un componente errato.\nAtteso: ' + partName + '\nRilevato: ' + scannedPart);
        return;
      }
      const payload = {
        assembly_code: assemblyCode,
        component_code: trimmed
      };
      fetch('{{ url_for('api.associate_component') }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      }).then(function(response) {
        return response.json();
      }).then(function(data) {
        if (data && data.status === 'ok') {
          alert('Componente associato con successo.');
          // Reload to update counts and readiness
          location.reload();
        } else {
          const msg = (data && data.error) ? data.error : 'Errore di associazione.';
          alert(msg);
        }
      }).catch(function(err) {
        console.error(err);
        alert('Errore di rete durante l\'associazione.');
      });
    });
  });
});
</script>

<!-- Show selected file names for product documentation uploads -->
<script>
// Display selected file names next to each file input in the product build form
document.addEventListener('DOMContentLoaded', function(){
  const form = document.querySelector('form');
  if (!form) return;
  form.addEventListener('change', function(e){
    const target = e.target;
    if (target && target.type === 'file') {
      // Each input is inside a doc-item div; find the nearest .file-name span within the same parent
      const fileNameSpan = target.parentElement.querySelector('.file-name');
      if (fileNameSpan) {
        if (target.files && target.files.length > 0) {
          fileNameSpan.textContent = target.files[0].name;
        } else {
          fileNameSpan.textContent = '';
        }
      }
    }
  });
});
</script>
{% endblock %}