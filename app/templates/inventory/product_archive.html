{% extends 'base.html' %}

{#
  Archive view for a single product – component events only.

  This template displays a chronological list of scan events for all
  parts and commercial components associated with the selected product.
  Assemblies are excluded from this view and instead shown in the
  dedicated "Archivio assiemi".  A search input allows filtering by
  DataMatrix, component name or description.  Each row shows the
  timestamp, a small image of the DataMatrix code on a white
  background, the component name, description, user who performed the
  action, the action type and any attached documents.  Documents are
  presented as buttons linking to their static paths.
#}

{% block title %}Magazzino – {{ product.name }}: Archivio componenti{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}"
       class="btn ghost small back-link"
       data-module-back="fallback"
       data-fallback-url="{{ url_for('inventory.product_detail', product_id=product.id) }}">← Indietro</a>
    <div class="page-heading-text">
      <h2 class="page-title">Magazzino · {{ product.name }}</h2>
      <p class="page-subtitle">Archivio componenti e tracciabilità dei documenti caricati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.product_assemblies', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'assemblies' else ' ghost' }}">Assiemi</a>
      <a href="{{ url_for('inventory.product_parts', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'parts' else ' ghost' }}">Parti</a>
      <a href="{{ url_for('inventory.product_commercial', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'commercial' else ' ghost' }}">Commerciali</a>
      <a href="{{ url_for('inventory.product_archive_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Archivio&nbsp;componenti</a>
      <a href="{{ url_for('inventory.product_archive_assemblies_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive_assiemi' else ' ghost' }}">Archivio&nbsp;assiemi</a>
    </div>
    <div class="archive-search">
      <input type="search" id="product-archive-search" placeholder="Cerca evento..." aria-label="Cerca nell'archivio componenti">
    </div>
  </div>

  {% if events_data|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento registrato per questo prodotto.</p>
    </div>
  {% else %}
    <div class="archive-card">
      <div class="archive-table-wrapper">
        <table class="archive-table" id="product-archive-table">
          <thead>
            <tr>
              <th scope="col">Data</th>
              <th scope="col">Ora</th>
              <th scope="col">DataMatrix</th>
              <th scope="col">Nome</th>
              <th scope="col">Descrizione</th>
              <th scope="col">Rev.</th>
              <th scope="col">Utente</th>
              <th scope="col">Docs</th>
            </tr>
          </thead>
          <tbody>
            {% for ev in events_data %}
              <tr data-archive-row>
                <td data-title="Data">
                  {% if ev.timestamp %}
                    {{ ev.timestamp.strftime('%d/%m/%Y') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-title="Ora">
                  {% if ev.timestamp %}
                    {{ ev.timestamp.strftime('%H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td data-title="DataMatrix" class="dm-cell">
                  <span class="dm-preview" data-code="{{ ev.datamatrix | e }}" aria-hidden="true"></span>
                  {% if ev.datamatrix %}<span class="sr-only">DataMatrix {{ ev.datamatrix }}</span>{% endif %}
                </td>
                <td data-title="Nome">{{ ev.name }}</td>
                <td data-title="Descrizione" title="{{ ev.description if ev.description else '' }}">{{ ev.description if ev.description else '—' }}</td>
                <td data-title="Rev.">{{ ev.revision if ev.revision else '—' }}</td>
                <td data-title="Utente">{{ ev.user if ev.user else '—' }}</td>
                <td data-title="Documenti" class="docs-cell">
                  {% if ev.docs and ev.docs|length > 0 %}
                    <a href="{{ url_for('inventory.product_event_docs_view', product_id=product.id, code=ev.datamatrix, ev_id=ev.id, src='components', stock_id=ev.stock_item_id) }}"
                       class="btn ghost small"
                       onclick="event.stopPropagation();">Docs</a>
                  {% else %}
                    <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('product-archive-search');
      const table = document.getElementById('product-archive-table');
      if (searchInput && table) {
        const rows = () => table.querySelectorAll('tbody tr[data-archive-row]');
        searchInput.addEventListener('input', function () {
          const query = this.value.toLowerCase().trim();
          rows().forEach((row) => {
            const text = row.textContent.toLowerCase();
            row.style.display = (!query || text.includes(query)) ? '' : 'none';
          });
        });
      }

      const dmContainers = document.querySelectorAll('#product-archive-table .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        el.innerHTML = '';
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall back to placeholder rendering below
          }
        }
        el.classList.add('dm-preview--fallback');
      });
    });
  </script>
</section>
{% endblock %}