{% extends 'base.html' %}

{#
  Assemblies archive view for a single product.

  This template displays DataMatrix scan events corresponding to
  assemblies (T=ASSIEME) and their associated component events.  Each
  assembly event is rendered as a collapsible row; expanding the row
  reveals the component events linked to it via the ASSOCIA scan
  action.  The refreshed layout reuses the archive utility classes so
  that component, assembly and production histories share the same
  visual language.
#}

{% block title %}Magazzino – {{ product.name }}: Archivio assiemi{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}"
       class="btn ghost small back-link"
       data-module-back="fallback"
       data-fallback-url="{{ url_for('inventory.product_detail', product_id=product.id) }}">← Indietro</a>
    <div>
      <h2 class="page-title">Magazzino · {{ product.name }}</h2>
      <p class="page-subtitle">Archivio assiemi e componenti collegati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.product_assemblies', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'assemblies' else ' ghost' }}">Assiemi</a>
      <a href="{{ url_for('inventory.product_parts', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'parts' else ' ghost' }}">Parti</a>
      <a href="{{ url_for('inventory.product_commercial', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'commercial' else ' ghost' }}">Commerciali</a>
      <a href="{{ url_for('inventory.product_archive_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Archivio&nbsp;componenti</a>
      <a href="{{ url_for('inventory.product_archive_assemblies_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive_assiemi' else ' ghost' }}">Archivio&nbsp;assiemi</a>
    </div>
    <div class="archive-search">
      <input type="search" id="assemblies-archive-search" placeholder="Cerca evento..." aria-label="Cerca nell'archivio assiemi">
    </div>
  </div>

  {% if assemblies|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento di assiemi registrato per questo prodotto.</p>
    </div>
  {% else %}
    <div id="assemblies-archive" class="archive-grid" style="--archive-columns: 150px 160px minmax(200px,1.4fr) minmax(220px,1.6fr) 90px 160px minmax(150px,1fr);">
      <div class="archive-header">
        <span>Data/Ora</span>
        <span>DataMatrix</span>
        <span>Nome</span>
        <span>Descrizione</span>
        <span>Rev.</span>
        <span>Utente</span>
        <span>Docs</span>
      </div>
      {% macro render_component(comp) %}
        {% set has_children = comp.components is defined and comp.components|length > 0 %}
        {% if has_children %}
          <details class="archive-node">
            <summary>
              <div class="archive-cell" data-title="Data/Ora">
                {% if comp.timestamp %}
                  <span class="cell-text">{{ comp.timestamp.strftime('%d/%m/%Y') }}</span>
                  <span class="muted">{{ comp.timestamp.strftime('%H:%M') }}</span>
                {% else %}
                  <span class="cell-text">—</span>
                {% endif %}
              </div>
              <div class="archive-cell" data-title="DataMatrix">
                <span class="dm-preview" data-code="{{ comp.datamatrix | e }}"></span>
                {% if comp.datamatrix %}<span class="muted" style="overflow-wrap:anywhere;">{{ comp.datamatrix }}</span>{% endif %}
              </div>
              <div class="archive-cell" data-title="Nome">
                <span class="cell-text">{{ comp.name }}</span>
              </div>
              <div class="archive-cell" data-title="Descrizione">
                <span class="cell-text" title="{{ comp.description if comp.description else '' }}">{{ comp.description if comp.description else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Rev.">
                <span class="cell-text">{{ comp.revision if comp.revision else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Utente">
                <span class="cell-text">{{ comp.user if comp.user else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Documenti">
                <div class="archive-docs">
                  {% if comp.docs and comp.docs|length > 0 %}
                    <a href="{{ url_for('inventory.product_docs_view', product_id=product.id, code=comp.datamatrix, src='assemblies') }}"
                       class="btn ghost small"
                       onclick="event.stopPropagation();">Docs</a>
                  {% else %}
                    <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
                  {% endif %}
                </div>
              </div>
            </summary>
            <div class="archive-children">
              {% for child in comp.components %}
                {{ render_component(child) }}
              {% endfor %}
            </div>
          </details>
        {% else %}
          <div class="archive-row" data-archive-row>
            <div class="archive-cell" data-title="Data/Ora">
              {% if comp.timestamp %}
                <span class="cell-text">{{ comp.timestamp.strftime('%d/%m/%Y') }}</span>
                <span class="muted">{{ comp.timestamp.strftime('%H:%M') }}</span>
              {% else %}
                <span class="cell-text">—</span>
              {% endif %}
            </div>
            <div class="archive-cell" data-title="DataMatrix">
              <span class="dm-preview" data-code="{{ comp.datamatrix | e }}"></span>
              {% if comp.datamatrix %}<span class="muted" style="overflow-wrap:anywhere;">{{ comp.datamatrix }}</span>{% endif %}
            </div>
            <div class="archive-cell" data-title="Nome">
              <span class="cell-text">{{ comp.name }}</span>
            </div>
            <div class="archive-cell" data-title="Descrizione">
              <span class="cell-text" title="{{ comp.description if comp.description else '' }}">{{ comp.description if comp.description else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Rev.">
              <span class="cell-text">{{ comp.revision if comp.revision else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Utente">
              <span class="cell-text">{{ comp.user if comp.user else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Documenti">
              <div class="archive-docs">
                {% if comp.docs and comp.docs|length > 0 %}
                  <a href="{{ url_for('inventory.product_docs_view', product_id=product.id, code=comp.datamatrix, src='assemblies') }}"
                     class="btn ghost small"
                     onclick="event.stopPropagation();">Docs</a>
                {% else %}
                  <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endmacro %}

      {% for asm in assemblies %}
        {{ render_component(asm) }}
      {% endfor %}
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('assemblies-archive-search');
      const container = document.getElementById('assemblies-archive');

      if (searchInput && container) {
        const leafRows = () => container.querySelectorAll('.archive-row[data-archive-row]');
        const detailNodes = () => container.querySelectorAll('details.archive-node');

        const applyFilter = (value) => {
          const query = value.toLowerCase().trim();
          if (!query) {
            leafRows().forEach((row) => {
              row.style.display = '';
            });
            detailNodes().forEach((node) => {
              node.style.display = '';
              node.open = false;
            });
            return;
          }

          leafRows().forEach((row) => {
            const match = row.textContent.toLowerCase().includes(query);
            row.style.display = match ? '' : 'none';
          });

          Array.from(detailNodes()).reverse().forEach((node) => {
            const summary = node.querySelector('summary');
            const summaryMatch = summary ? summary.textContent.toLowerCase().includes(query) : false;
            const children = node.querySelectorAll(':scope > .archive-children > *');
            let childVisible = false;
            children.forEach((child) => {
              if (child.style.display !== 'none') {
                childVisible = true;
              }
            });
            const shouldShow = summaryMatch || childVisible;
            node.style.display = shouldShow ? '' : 'none';
            node.open = shouldShow;
          });
        };

        searchInput.addEventListener('input', function () {
          applyFilter(this.value);
        });
      }

      const dmContainers = document.querySelectorAll('#assemblies-archive .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.innerHTML = '';
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall back to text rendering
          }
        }
        el.textContent = code;
      });
    });
  </script>
</section>
{% endblock %}
