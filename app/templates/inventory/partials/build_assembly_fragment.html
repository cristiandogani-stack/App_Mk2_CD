{% set inline_mode = inline_mode | default(False) %}
{% if embedded %}
<style>
  .app-header, .nav-mobile { display:none !important; }
  .back-link { display:none !important; }
</style>
<script>
(function(){
  function init(){
    const form = document.querySelector('form');
    if (!form) return;
    form.addEventListener('submit', function(e){
      const ok = confirm('Confermare la costruzione dell\'assiemi?');
      if (!ok) {
        e.preventDefault();
        return;
      }
      setTimeout(function(){
        var notifier = function(){
          if (typeof window.handleInlineBuildComplete === 'function') {
            window.handleInlineBuildComplete('success');
            return true;
          }
          return false;
        };
        if (!notifier()) {
          if (window.parent && window.parent !== window) {
            try {
              if (typeof window.parent.handleInlineBuildComplete === 'function') {
                window.parent.handleInlineBuildComplete('success');
              } else if (typeof window.parent.handleEmbeddedBuildComplete === 'function') {
                window.parent.handleEmbeddedBuildComplete('success');
              } else {
                window.parent.location.reload();
              }
            } catch (err) {
              console.error(err);
            }
          } else {
            window.location.reload();
          }
        }
      }, 1000);
    });
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{% endif %}
<section class="section workflow-section{% if inline_mode %} inline-build-fragment{% endif %}">
  <div class="glass workflow-container">
    <div class="workflow-hero">
      <div class="workflow-hero-main">
        <div class="workflow-thumb">
          {% set asm_image = assembly.display_image_filename or assembly.image_filename %}
          {% if asm_image %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + asm_image) }}" alt="{{ assembly.name }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ assembly.name }}" style="filter:invert(1); opacity:0.7;">
          {% endif %}
        </div>
        <div class="workflow-hero-copy">
          <span class="workflow-eyebrow">Costruzione assieme</span>
          <h1 class="workflow-title">{{ assembly.name }}</h1>
          {% if assembly.description %}
            <p class="workflow-subtitle">{{ assembly.description }}</p>
          {% endif %}
        </div>
      </div>
      <div class="workflow-hero-actions">
        <span id="assembly-status" class="workflow-indicator" title="Stato lavorazione">
          {{ 'ðŸŸ¢ Pronto' if docs_ready and assoc_ready else 'ðŸ”´ In attesa' }}
        </span>
        {% if not inline_mode %}
          <a href="{{ back_url or url_for('inventory.list_assemblies') }}" class="btn ghost small back-link">Indietro</a>
        {% endif %}
      </div>
    </div>
    <form method="post" enctype="multipart/form-data" class="workflow-form form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="back_url" value="{{ back_url or url_for('inventory.list_assemblies') }}">
      {% set asm_docs = required_docs.get(assembly.id, []) %}
      {% set doc_label_map = {
        'qualita': 'Modulo Cert. qualitÃ ',
        '3_1_materiale': '3.1 Materiale',
        'step_tavole': 'Step/tavola',
        'funzionamento': 'Verifica funzionamento',
        'istruzioni': 'Montaggio istruzioni',
        'ddt_fornitore': 'DDT fornitore',
        'altro': 'Altro'
      } %}
      <div class="workflow-body">
        <div class="workflow-main">
          <div class="workflow-block">
            <h4>Associa i componenti richiesti</h4>
            {% if parts|length > 0 %}
              <p class="muted" style="margin:0 0 12px;">Scansiona ogni componente per raggiungere il totale richiesto e abilita la costruzione.</p>
              <div class="grid grid-2 workflow-association-grid">
                {% for part in parts %}
                <div class="card glass workflow-association-card">
                  <div class="workflow-association-thumb">
                    {% if part.display_image_filename %}
                      <img loading="lazy" src="{{ url_for('static', filename='uploads/' + part.display_image_filename) }}" alt="{{ part.name }}">
                    {% else %}
                      <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ part.name }}" style="filter: invert(1); opacity:0.7;">
                    {% endif %}
                  </div>
                  <h4 class="workflow-association-title">{{ part.name }}</h4>
                  <p class="workflow-association-meta">Richiesti: {{ required_quantities.get(part.id, 1) }}</p>
                  <p class="workflow-association-meta">Associati: {{ associated_counts.get(part.id, 0) }}</p>
                  <button type="button"
                          class="btn small primary associate"
                          data-part-id="{{ part.id }}"
                          data-part-name="{{ part.name }}"
                          data-required="{{ required_quantities.get(part.id, 1) }}"
                          data-associated="{{ associated_counts.get(part.id, 0) }}"
                          {% if associated_counts.get(part.id, 0) >= required_quantities.get(part.id, 1) %}disabled{% endif %}>Associa</button>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted" style="margin:0;">Nessun componente collegato a questo assieme.</p>
            {% endif %}
          </div>
        </div>
        <aside class="workflow-side">
          <div class="workflow-block">
            <h4>Documenti assieme</h4>
            {% if asm_docs|length > 0 %}
              <div class="document-section">
                {% for doc in asm_docs %}
                  <div class="document-card">
                    <div class="document-card-header">
                      <div class="document-card-titles">
                        <span class="document-card-title">{{ doc_label_map.get(doc.type, doc.type) }}</span>
                      </div>
                      <div class="document-card-meta">
                        {% if doc.original_filename %}
                          <a href="{{ url_for('products.download_file', filename=doc.original_filename) }}" target="_blank" class="btn ghost small" style="white-space:nowrap;">Scarica</a>
                        {% else %}
                          <span class="muted" style="white-space:nowrap;">â€”</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="document-card-body">
                      <input type="file" name="{{ doc.field_name }}" required>
                      <span class="file-name document-file-name"></span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted" style="margin:0;">Nessuna documentazione richiesta per l'assieme.</p>
            {% endif %}
          </div>
        </aside>
      </div>
      <div class="workflow-footer">
        {% if not inline_mode %}
          <a href="{{ back_url or url_for('inventory.list_assemblies') }}" class="btn ghost">Annulla</a>
        {% endif %}
        <button type="submit" class="btn primary" {% if not ready_all %}disabled{% endif %}>Costruisci</button>
      </div>
    </form>
  </div>
</section>
<script>
(function(){
  function initDocReady(){
    const form = document.querySelector('form');
    if (!form) return;
    const fileInputs = form.querySelectorAll('input[type="file"]');
    const semSpan = document.getElementById('assembly-status');
    const buildBtn = form.querySelector('button[type="submit"]');
    const readyParts = {{ ready_parts | tojson | safe }};
    const assocReady = {{ assoc_ready | tojson | safe }};
    function update(){
      let docsOk = fileInputs.length === 0;
      if (!docsOk) {
        docsOk = true;
        fileInputs.forEach(function(inp){
          if (!inp.files || inp.files.length === 0) {
            docsOk = false;
          }
        });
      }
      if (semSpan) {
        semSpan.textContent = docsOk && readyParts && assocReady ? 'ðŸŸ¢ Pronto' : 'ðŸ”´ In attesa';
      }
      if (buildBtn) {
        buildBtn.disabled = !(docsOk && readyParts && assocReady);
      }
    }
    fileInputs.forEach(function(inp){
      inp.addEventListener('change', update);
    });
    update();
  }
  function initFileLabels(){
    const form = document.querySelector('form');
    if (!form) return;
    form.addEventListener('change', function(e){
      const target = e.target;
      if (target && target.type === 'file') {
        const fileNameSpan = target.parentElement.querySelector('.file-name');
        if (fileNameSpan) {
          fileNameSpan.textContent = (target.files && target.files.length > 0) ? target.files[0].name : '';
        }
      }
    });
  }
  function initAssociations(){
    const assemblyCode = {{ assembly_code | tojson | safe }};
    const associateButtons = document.querySelectorAll('.associate');
    associateButtons.forEach(function(btn){
      btn.addEventListener('click', function(){
        if (!assemblyCode) {
          alert('Nessun codice assieme disponibile. Apri la costruzione da una prenotazione con scatola.');
          return;
        }
        const partName = this.dataset.partName || '';
        const scanned = prompt('Scansiona il datamatrix del componente ' + partName + ':');
        if (!scanned) {
          return;
        }
        const trimmed = scanned.trim();
        let scannedPart = '';
        try {
          trimmed.split('|').forEach(function(seg){
            if (seg.startsWith('P=')) {
              scannedPart = seg.substring(2);
            }
          });
        } catch (err) {
          scannedPart = '';
        }
        if (scannedPart && partName && scannedPart.toLowerCase() !== partName.toLowerCase()) {
          const proceed = confirm('Il codice letto (' + scannedPart + ') non corrisponde a ' + partName + '. Continuare comunque?');
          if (!proceed) {
            return;
          }
        }
        fetch('{{ url_for('api.associate_component') }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            assembly_code: assemblyCode,
            component_code: trimmed,
            part_id: this.dataset.partId
          })
        }).then(function(resp){
          if (resp.ok) {
            window.location.reload();
          } else {
            return resp.json().then(function(data){
              alert(data.message || 'Impossibile associare il componente.');
            });
          }
        }).catch(function(){
          alert('Si Ã¨ verificato un errore durante l\'associazione.');
        });
      });
    });
  }
  function init(){
    initDocReady();
    initFileLabels();
    initAssociations();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
