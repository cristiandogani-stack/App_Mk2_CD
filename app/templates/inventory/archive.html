{% extends 'base.html' %}

{#
  Global production history view.

  This template presents the complete list of finished product builds in
  the warehouse.  Each build is rendered as a collapsible row showing
  when it was created, its DataMatrix code, the product name,
  description, the operator who performed the build and any
  associated documents.  Expanding a row reveals the components
  consumed during the build.  Nested sub‑assemblies are displayed
  recursively so that operators can inspect the entire exploded bill
  of materials for every production event.
#}

{% block title %}Magazzino – Storico produzione{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.index') }}"
       class="btn ghost small back-link"
       data-fallback-url="{{ url_for('inventory.index') }}">← Indietro</a>
    <div>
      <h2 class="page-title">Magazzino · Storico produzione</h2>
      <p class="page-subtitle">Cronologia delle costruzioni con dettaglio dei componenti consumati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.index') }}"
         class="btn small{{ ' primary' if active_tab == 'products' else ' ghost' }}">Prodotti</a>
      <a href="{{ url_for('inventory.archive') }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Storico&nbsp;produzione</a>
    </div>
    <div class="archive-search">
      <input type="search" id="production-history-search" placeholder="Cerca evento..." aria-label="Cerca nello storico produzione">
    </div>
  </div>

  {% if assemblies|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento registrato.</p>
    </div>
  {% else %}
    <div id="production-history" class="archive-grid" style="--archive-columns: 150px 160px minmax(200px,1.4fr) minmax(240px,1.6fr) 90px 160px minmax(150px,1fr);">
      <div class="archive-header">
        <span>Data/Ora</span>
        <span>DataMatrix</span>
        <span>Nome</span>
        <span>Descrizione</span>
        <span>Rev.</span>
        <span>Utente</span>
        <span>Docs</span>
      </div>
      {% macro render_node(node) %}
        {% set has_children = node.components is defined and node.components|length > 0 %}
        {% if has_children %}
          <details class="archive-node">
            <summary>
              <div class="archive-cell" data-title="Data/Ora">
                {% if node.timestamp %}
                  <span class="cell-text">{{ node.timestamp.strftime('%d/%m/%Y') }}</span>
                  <span class="muted">{{ node.timestamp.strftime('%H:%M') }}</span>
                {% else %}
                  <span class="cell-text">—</span>
                {% endif %}
              </div>
              <div class="archive-cell" data-title="DataMatrix">
                <span class="dm-preview" data-code="{{ node.datamatrix | e }}"></span>
                {% if node.datamatrix %}<span class="muted" style="overflow-wrap:anywhere;">{{ node.datamatrix }}</span>{% endif %}
              </div>
              <div class="archive-cell" data-title="Nome">
                <span class="cell-text">{{ node.name }}</span>
              </div>
              <div class="archive-cell" data-title="Descrizione">
                <span class="cell-text" title="{{ node.description if node.description else '' }}">{{ node.description if node.description else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Rev.">
                <span class="cell-text">{{ node.revision if node.revision else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Utente">
                <span class="cell-text">{{ node.user if node.user else '—' }}</span>
              </div>
              <div class="archive-cell" data-title="Documenti">
                <div class="archive-docs">
                  {% if node.product_id %}
                    <a href="{{ url_for('inventory.product_docs_view', product_id=node.product_id, code=node.datamatrix, src='archive', box_id=node.box_id) }}"
                       class="btn ghost small"
                       onclick="event.stopPropagation();">Docs</a>
                  {% else %}
                    <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
                  {% endif %}
                </div>
              </div>
            </summary>
            <div class="archive-children">
              {% for child in node.components %}
                {{ render_node(child) }}
              {% endfor %}
            </div>
          </details>
        {% else %}
          <div class="archive-row" data-archive-row>
            <div class="archive-cell" data-title="Data/Ora">
              {% if node.timestamp %}
                <span class="cell-text">{{ node.timestamp.strftime('%d/%m/%Y') }}</span>
                <span class="muted">{{ node.timestamp.strftime('%H:%M') }}</span>
              {% else %}
                <span class="cell-text">—</span>
              {% endif %}
            </div>
            <div class="archive-cell" data-title="DataMatrix">
              <span class="dm-preview" data-code="{{ node.datamatrix | e }}"></span>
              {% if node.datamatrix %}<span class="muted" style="overflow-wrap:anywhere;">{{ node.datamatrix }}</span>{% endif %}
            </div>
            <div class="archive-cell" data-title="Nome">
              <span class="cell-text">{{ node.name }}</span>
            </div>
            <div class="archive-cell" data-title="Descrizione">
              <span class="cell-text" title="{{ node.description if node.description else '' }}">{{ node.description if node.description else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Rev.">
              <span class="cell-text">{{ node.revision if node.revision else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Utente">
              <span class="cell-text">{{ node.user if node.user else '—' }}</span>
            </div>
            <div class="archive-cell" data-title="Documenti">
              <div class="archive-docs">
                {% if node.product_id %}
                  <a href="{{ url_for('inventory.product_docs_view', product_id=node.product_id, code=node.datamatrix, src='archive', box_id=node.box_id) }}"
                     class="btn ghost small"
                     onclick="event.stopPropagation();">Docs</a>
                {% else %}
                  <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endmacro %}

      {% for asm in assemblies %}
        {{ render_node(asm) }}
      {% endfor %}
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('production-history-search');
      const container = document.getElementById('production-history');

      if (searchInput && container) {
        const leafRows = () => container.querySelectorAll('.archive-row[data-archive-row]');
        const detailNodes = () => container.querySelectorAll('details.archive-node');

        const applyFilter = (value) => {
          const query = value.toLowerCase().trim();
          if (!query) {
            leafRows().forEach((row) => {
              row.style.display = '';
            });
            detailNodes().forEach((node) => {
              node.style.display = '';
              node.open = false;
            });
            return;
          }

          leafRows().forEach((row) => {
            const match = row.textContent.toLowerCase().includes(query);
            row.style.display = match ? '' : 'none';
          });

          Array.from(detailNodes()).reverse().forEach((node) => {
            const summary = node.querySelector('summary');
            const summaryMatch = summary ? summary.textContent.toLowerCase().includes(query) : false;
            const children = node.querySelectorAll(':scope > .archive-children > *');
            let childVisible = false;
            children.forEach((child) => {
              if (child.style.display !== 'none') {
                childVisible = true;
              }
            });
            const shouldShow = summaryMatch || childVisible;
            node.style.display = shouldShow ? '' : 'none';
            node.open = shouldShow;
          });
        };

        searchInput.addEventListener('input', function () {
          applyFilter(this.value);
        });
      }

      const dmContainers = document.querySelectorAll('#production-history .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.innerHTML = '';
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall back to text rendering
          }
        }
        el.textContent = code;
      });
    });
  </script>
</section>
{% endblock %}
