{% extends 'base.html' %}

{#
  Production box detail view.

  Lists all stock items contained within a production box along with
  their current status and a summary of associated documents.  When
  the box has not yet been completed operators can either load
  outstanding components or launch the guided build workflow for
  assemblies and finished products.
#}

{% block title %}
  {%- set ep = request.endpoint or '' -%}
  {%- set bp = ep.split('.')|first -%}
  {%- set prefix = 'Produzione' if bp == 'production' else 'Magazzino' -%}
  {{ prefix }} ‚Äì Box {{ box.code }}
{% endblock %}

{% block content %}
{% set is_completed = (box.status == 'COMPLETATO') %}
{% set allow_build = (not is_completed and box.box_type in ['ASSIEME', 'PRODOTTO'] and (box.assembly_id or box.product_id)) %}
{% set allow_load = (not is_completed and box.box_type not in ['ASSIEME', 'PRODOTTO'] and box.lot_management) %}
{% set show_row_actions = (not box.lot_management and box.box_type not in ['ASSIEME', 'PRODOTTO'] and not is_completed) %}
{% set load_base_url = url_for('inventory.load_component', part_id=box.root_structure.id) if box.root_structure else None %}
{% set hero_label = 'Box assieme' if box.box_type == 'ASSIEME' else 'Box prodotto' if box.box_type == 'PRODOTTO' else 'Box commerciale' if box.box_type == 'COMMERCIALE' else 'Box componenti' %}
{% set hero_name = box.root_structure.name if box.root_structure and box.root_structure.name else (box.product_name if box.product_name else 'Box ' ~ box.code) %}
{% set total_items = box.stock_items|length %}
{% set loaded_items = box.stock_items|selectattr('status', 'equalto', 'COMPLETATO')|list|length %}
{% set pending_items = total_items - loaded_items %}
{% if is_completed %}
{%   set visible_items = box.stock_items %}
{% else %}
{%   set visible_items = box.stock_items|rejectattr('status', 'equalto', 'COMPLETATO')|list %}
{% endif %}

<section class="section workflow-section production-box-section"
         data-box-id="{{ box.id }}"
         data-load-base="{{ load_base_url or '' }}">
  <div class="glass workflow-container production-box-container">
    <div class="workflow-hero">
      <div class="workflow-hero-main">
        <div class="workflow-thumb production-box-thumb">
          {% set hero_item = box.root_structure %}
          {% if hero_item and hero_item.display_image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.display_image_filename) }}" alt="{{ hero_name }}">
          {% elif hero_item and hero_item.image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.image_filename) }}" alt="{{ hero_name }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ hero_name }}" style="filter: invert(1); opacity:0.7;">
          {% endif %}
        </div>
        <div class="workflow-hero-copy">
          <span class="workflow-eyebrow">{{ hero_label }}</span>
          <h1 class="workflow-title">{{ hero_name }}</h1>
          <p class="workflow-subtitle">Codice box {{ box.code }}</p>
        </div>
      </div>
      <div class="workflow-hero-actions">
        <span class="workflow-indicator">{{ 'üü¢ Pronto' if is_completed else 'üî¥ In attesa' }}</span>
        <div class="workflow-hero-buttons">
          {% if allow_build %}
            <button id="btn-open-build" type="button" class="btn primary"
                    {% if box.assembly_id %}
                      data-build-url="{{ url_for('inventory.build_assembly', assembly_id=box.assembly_id) }}?embedded=1&box_id={{ box.id }}"
                    {% elif box.product_id %}
                      data-build-url="{{ url_for('inventory.build_product', product_id=box.product_id) }}?embedded=1&box_id={{ box.id }}"
                    {% endif %}
            >Costruisci</button>
          {% endif %}
          <a href="#" class="btn ghost small back-link"
             onclick="if (document.referrer) { window.location.href = document.referrer; } else { window.history.back(); } return false;">‚Üê Indietro</a>
        </div>
      </div>
    </div>
    <div class="production-box-body">
      <div class="production-box-summary">
        <div class="production-box-stat">
          <span class="production-box-stat-label">Totale componenti</span>
          <span class="production-box-stat-value">{{ total_items }}</span>
        </div>
        <div class="production-box-stat">
          <span class="production-box-stat-label">Caricati</span>
          <span class="production-box-stat-value">{{ loaded_items }}</span>
        </div>
        {% if not is_completed and pending_items > 0 %}
          <div class="production-box-stat">
            <span class="production-box-stat-label">In lavorazione</span>
            <span class="production-box-stat-value">{{ pending_items }}</span>
          </div>
        {% endif %}
      </div>

      <div class="workflow-block">
        <div class="workflow-block-header">
          <h4>Documenti checklist</h4>
          {% if allow_load %}
            <button id="btn-open-load" type="button" class="btn small primary"
                    data-load-url="{{ load_base_url or '' }}">Carica documenti</button>
          {% endif %}
        </div>
        {% if box.required_docs and box.required_docs|length > 0 %}
          <div class="document-section">
            {% for doc in box.required_docs %}
              {% set doc_path = doc.path if doc.path else None %}
              {% set doc_title = doc.title if doc.title else 'Documento' %}
              {% set doc_filename = doc.filename if doc.filename else (doc_path.split('/')[-1] if doc_path else '') %}
              <div class="document-card">
                <div class="document-card-header">
                  <div class="document-card-titles">
                    <span class="document-card-title">{{ doc_title }}</span>
                    {% if doc_filename %}
                      <span class="document-card-filename" title="{{ doc_filename }}">{{ doc_filename }}</span>
                    {% endif %}
                  </div>
                  <div class="document-card-meta">
                    {% if doc_path %}
                      <a href="{{ url_for('static', filename=doc_path) }}"
                         class="btn ghost small"
                         download="{{ doc_filename or doc_title }}">Scarica</a>
                    {% else %}
                      <span class="muted" style="white-space:nowrap;">‚Äî</span>
                    {% endif %}
                  </div>
                </div>
                <div class="document-card-body">
                  <p class="muted" style="margin:0;">Contrassegnato nella checklist del componente.</p>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Nessun documento selezionato nella checklist per questo box.</p>
        {% endif %}
        {% if show_row_actions %}
          <p class="muted" style="margin-top:12px;">Utilizza il pulsante ‚ÄúCarica‚Äù accanto a ciascun componente per allegare i documenti.</p>
        {% endif %}
      </div>

      <div class="workflow-block">
        <div class="workflow-block-header">
          <h4>Componenti nel box</h4>
          {% if is_completed %}
            <span class="status-pill status-ready">Completato</span>
          {% else %}
            <span class="status-pill status-progress">In lavorazione</span>
          {% endif %}
        </div>
        {% if total_items == 0 %}
          <p class="muted" style="margin:0;">Il box √® vuoto.</p>
        {% elif visible_items|length == 0 %}
          <p class="muted" style="margin:0;">Tutti i componenti sono stati caricati.</p>
        {% else %}
          <div class="table-scroll">
            <table class="production-box-table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">DataMatrix</th>
                  <th scope="col">Elemento</th>
                  <th scope="col">Stato</th>
                  <th scope="col" class="text-right">Download</th>
                  {% if show_row_actions %}
                    <th scope="col" class="text-right">Azioni</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% set row = namespace(index=0) %}
                {% for item in visible_items %}
                  {% set row.index = row.index + 1 %}
                  {% set status_class = 'status-ready' if item.status == 'COMPLETATO' else 'status-progress' if item.status in ['IN_LAVORAZIONE', 'IN_PREPARAZIONE'] else 'status-pending' %}
                  <tr>
                    <td data-title="#">{{ row.index }}</td>
                    <td data-title="DataMatrix">
                      <div class="dm-container"
                           data-dm-code="{{ (item.datamatrix_payload or '') | e }}">
                        {% if item.datamatrix_image %}
                          <img src="data:image/png;base64,{{ item.datamatrix_image }}"
                               alt="Datamatrix {{ item.product.code or item.product.name }}"
                               loading="lazy"
                               class="dm-image dm-image-fallback"
                               data-dm-image="{{ item.datamatrix_image }}">
                        {% endif %}
                        {% if not item.datamatrix_image %}
                          {% if item.datamatrix_payload %}
                            <span class="dm-fallback" title="{{ item.datamatrix_payload }}">{{ item.datamatrix_payload }}</span>
                          {% else %}
                            <span class="dm-fallback muted">‚Äî</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </td>
                    <td data-title="Elemento">
                      <div class="production-box-item">
                        <span class="production-box-item-name">{{ item.product.name }}</span>
                        {% if item.product.code %}
                          <span class="production-box-item-code">{{ item.product.code }}</span>
                        {% endif %}
                      </div>
                    </td>
                    <td data-title="Stato">
                      <span class="status-pill {{ status_class }}">{{ item.status }}</span>
                    </td>
                    <td data-title="Download" class="text-right">
                      <button class="btn small ghost dm-download"
                              type="button"
                              data-dm-image="{{ item.datamatrix_image or '' }}"
                              data-dm-code="{{ (item.datamatrix_payload or '') | e }}"
                              data-base-name="{{ item.product.code or 'datamatrix' }}">Scarica&nbsp;Datamatrix</button>
                    </td>
                    {% if show_row_actions %}
                      <td data-title="Azioni" class="text-right">
                        <button class="btn small primary load-item"
                                type="button"
                                data-item-id="{{ item.id }}"
                                data-load-url="{{ load_base_url or '' }}">Carica</button>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
      {% if allow_build %}
        <div class="workflow-block build-inline" id="build-inline-panel" hidden>
          <div class="workflow-block-header">
            <h4>Procedura di costruzione</h4>
            <button id="btn-close-build" type="button" class="btn ghost small">Chiudi</button>
          </div>
          <div class="build-inline-body">
            <div class="build-inline-loader" role="status" aria-live="polite">
              <div class="workflow-spinner" role="presentation"></div>
              <p>Caricamento interfaccia‚Ä¶</p>
            </div>
            <iframe id="buildFrame" src="" class="build-inline-frame" title="Procedura costruzione"></iframe>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script defer src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
{% endblock %}
