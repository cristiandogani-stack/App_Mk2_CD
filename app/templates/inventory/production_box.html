{% extends 'base.html' %}

{#
  Production box detail view.

  Lists all stock items contained within a production box along with
  their current status and a summary of associated documents.  When
  the box has not yet been completed operators can either load
  outstanding components or launch the guided build workflow for
  assemblies and finished products.
#}

{% block title %}
  {%- set ep = request.endpoint or '' -%}
  {%- set bp = ep.split('.')|first -%}
  {%- set prefix = 'Produzione' if bp == 'production' else 'Magazzino' -%}
  {{ prefix }} ‚Äì Box {{ box.code }}
{% endblock %}

{% block content %}
{% set is_completed = (box.status == 'COMPLETATO') %}
{% set allow_build = (not is_completed and box.box_type in ['ASSIEME', 'PRODOTTO'] and (box.assembly_id or box.product_id)) %}
{% set allow_load = (not is_completed and box.box_type not in ['ASSIEME', 'PRODOTTO'] and box.lot_management) %}
{% set show_row_actions = (not box.lot_management and box.box_type not in ['ASSIEME', 'PRODOTTO'] and not is_completed) %}
{% set load_base_url = url_for('inventory.load_component', part_id=box.root_structure.id) if box.root_structure else None %}
{% set hero_label = 'Box assieme' if box.box_type == 'ASSIEME' else 'Box prodotto' if box.box_type == 'PRODOTTO' else 'Box commerciale' if box.box_type == 'COMMERCIALE' else 'Box componenti' %}
{% set hero_name = box.root_structure.name if box.root_structure and box.root_structure.name else (box.product_name if box.product_name else 'Box ' ~ box.code) %}
{% set total_items = box.stock_items|length %}
{% set loaded_items = box.stock_items|selectattr('status', 'equalto', 'COMPLETATO')|list|length %}
{% set pending_items = total_items - loaded_items %}
{% if is_completed %}
{%   set visible_items = box.stock_items %}
{% else %}
{%   set visible_items = box.stock_items|rejectattr('status', 'equalto', 'COMPLETATO')|list %}
{% endif %}

<section class="section workflow-section production-box-section">
  <div class="glass workflow-container production-box-container">
    <div class="workflow-hero">
      <div class="workflow-hero-main">
        <div class="workflow-thumb production-box-thumb">
          {% set hero_item = box.root_structure %}
          {% if hero_item and hero_item.display_image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.display_image_filename) }}" alt="{{ hero_name }}">
          {% elif hero_item and hero_item.image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.image_filename) }}" alt="{{ hero_name }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ hero_name }}" style="filter: invert(1); opacity:0.7;">
          {% endif %}
        </div>
        <div class="workflow-hero-copy">
          <span class="workflow-eyebrow">{{ hero_label }}</span>
          <h1 class="workflow-title">{{ hero_name }}</h1>
          <p class="workflow-subtitle">Codice box {{ box.code }}</p>
        </div>
      </div>
      <div class="workflow-hero-actions">
        <span class="workflow-indicator">{{ 'üü¢ Pronto' if is_completed else 'üî¥ In attesa' }}</span>
        <div class="workflow-hero-buttons">
          {% if allow_build %}
            <button id="btn-open-build" class="btn primary"
                    {% if box.assembly_id %}
                      data-build-url="{{ url_for('inventory.build_assembly', assembly_id=box.assembly_id) }}?embedded=1&box_id={{ box.id }}"
                    {% elif box.product_id %}
                      data-build-url="{{ url_for('inventory.build_product', product_id=box.product_id) }}?embedded=1&box_id={{ box.id }}"
                    {% endif %}
            >Costruisci</button>
          {% endif %}
          <a href="#" class="btn ghost small back-link"
             onclick="if (document.referrer) { window.location.href = document.referrer; } else { window.history.back(); } return false;">‚Üê Indietro</a>
        </div>
      </div>
    </div>
    <div class="production-box-body">
      <div class="production-box-summary">
        <div class="production-box-stat">
          <span class="production-box-stat-label">Totale componenti</span>
          <span class="production-box-stat-value">{{ total_items }}</span>
        </div>
        <div class="production-box-stat">
          <span class="production-box-stat-label">Caricati</span>
          <span class="production-box-stat-value">{{ loaded_items }}</span>
        </div>
        <div class="production-box-stat">
          <span class="production-box-stat-label">Da lavorare</span>
          <span class="production-box-stat-value">{{ pending_items if pending_items > 0 else 0 }}</span>
        </div>
      </div>

      <div class="workflow-block">
        <div class="workflow-block-header">
          <h4>Documenti checklist</h4>
          {% if allow_load %}
            <button id="btn-open-load" type="button" class="btn small primary">Carica documenti</button>
          {% endif %}
        </div>
        {% if box.required_docs and box.required_docs|length > 0 %}
          <div class="document-section">
            {% for doc in box.required_docs %}
              {% set doc_path = doc.path if doc.path else None %}
              {% set doc_name = doc.name if doc.name else (doc_path.split('/')[-1] if doc_path else 'Documento') %}
              <div class="document-card">
                <div class="document-card-header">
                  <span class="document-card-title">{{ doc_name }}</span>
                  <div class="document-card-meta">
                    {% if doc_path %}
                      <a href="{{ url_for('static', filename=doc_path) }}" target="_blank" class="btn ghost small">Scarica</a>
                    {% else %}
                      <span class="muted" style="white-space:nowrap;">‚Äî</span>
                    {% endif %}
                  </div>
                </div>
                <div class="document-card-body">
                  <p class="muted" style="margin:0;">Contrassegnato nella checklist del componente.</p>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin:0;">Nessun documento selezionato nella checklist per questo box.</p>
        {% endif %}
        {% if show_row_actions %}
          <p class="muted" style="margin-top:12px;">Utilizza il pulsante ‚ÄúCarica‚Äù accanto a ciascun componente per allegare i documenti.</p>
        {% endif %}
      </div>

      <div class="workflow-block">
        <div class="workflow-block-header">
          <h4>Componenti nel box</h4>
          {% if is_completed %}
            <span class="status-pill status-ready">Completato</span>
          {% else %}
            <span class="status-pill status-progress">In lavorazione</span>
          {% endif %}
        </div>
        {% if total_items == 0 %}
          <p class="muted" style="margin:0;">Il box √® vuoto.</p>
        {% elif visible_items|length == 0 %}
          <p class="muted" style="margin:0;">Tutti i componenti sono stati caricati.</p>
        {% else %}
          <div class="table-scroll">
            <table class="production-box-table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">DataMatrix</th>
                  <th scope="col">Elemento</th>
                  <th scope="col">Stato</th>
                  <th scope="col" class="text-right">Download</th>
                  {% if show_row_actions %}
                    <th scope="col" class="text-right">Azioni</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% set row = namespace(index=0) %}
                {% for item in visible_items %}
                  {% set row.index = row.index + 1 %}
                  {% set status_class = 'status-ready' if item.status == 'COMPLETATO' else 'status-progress' if item.status in ['IN_LAVORAZIONE', 'IN_PREPARAZIONE'] else 'status-pending' %}
                  <tr>
                    <td data-title="#">{{ row.index }}</td>
                    <td data-title="DataMatrix">
                      <div class="dm-container" data-code="{{ item.datamatrix_code | e }}"></div>
                    </td>
                    <td data-title="Elemento">
                      <div class="production-box-item">
                        <span class="production-box-item-name">{{ item.product.name }}</span>
                        {% if item.product.code %}
                          <span class="production-box-item-code">{{ item.product.code }}</span>
                        {% endif %}
                      </div>
                    </td>
                    <td data-title="Stato">
                      <span class="status-pill {{ status_class }}">{{ item.status }}</span>
                    </td>
                    <td data-title="Download" class="text-right">
                      <button class="btn small ghost dm-download">Scarica&nbsp;Datamatrix</button>
                    </td>
                    {% if show_row_actions %}
                      <td data-title="Azioni" class="text-right">
                        <button class="btn small primary load-item" data-item-id="{{ item.id }}">Carica</button>
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% if allow_build %}
<div id="buildModal" class="workflow-modal" style="display:none;">
  <div class="workflow-modal-dialog">
    <div class="workflow-modal-header">
      <h3 class="workflow-modal-title">Costruisci {{ hero_name }}</h3>
      <button id="btn-close-build" class="btn ghost small workflow-modal-close">Chiudi</button>
    </div>
    <iframe id="buildFrame" src="" class="workflow-modal-frame"></iframe>
  </div>
</div>
{% endif %}

{% if box.box_type not in ['ASSIEME', 'PRODOTTO'] %}
<div id="loadModal" class="workflow-modal" style="display:none;" data-base-url="{{ load_base_url or '' }}">
  <div class="workflow-modal-dialog">
    <div class="workflow-modal-header">
      <h3 class="workflow-modal-title">Carica {{ hero_name }}</h3>
      <button id="btn-close-load" class="btn ghost small workflow-modal-close">Chiudi</button>
    </div>
    <iframe id="loadFrame" src="" class="workflow-modal-frame"></iframe>
  </div>
</div>
{% endif %}

{% endblock %}

{# Load the client-side DataMatrix library.  This script defines a global
   `DATAMatrix` function which creates SVG elements representing the
   specified message.  The library must be loaded before the code
   below invokes `DATAMatrix` to render and download DataMatrix codes. #}
<script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const loadModal = document.getElementById('loadModal');
  const loadFrame = document.getElementById('loadFrame');
  const loadBaseUrl = loadModal ? loadModal.getAttribute('data-base-url') : '';

  function resetLoadModal(){
    if (loadFrame) {
      loadFrame.onload = null;
      loadFrame.src = '';
    }
    if (loadModal) {
      loadModal.style.display = 'none';
      loadModal.setAttribute('aria-hidden', 'true');
    }
  }

  function attachLoadWatcher(){
    if (!loadFrame || !loadModal) {
      return;
    }
    loadFrame.onload = function(){
      try {
        const loc = loadFrame.contentWindow.location;
        const href = loc && loc.href ? loc.href : '';
        const path = loc && loc.pathname ? loc.pathname : '';
        if (path && !path.startsWith('/inventory/load') && !(href.startsWith('about:'))) {
          loadFrame.onload = null;
          loadFrame.src = '';
          loadModal.style.display = 'none';
          loadModal.setAttribute('aria-hidden', 'true');
          window.location.reload();
        }
      } catch (err) {
        // Ignore errors caused by blank or cross‚Äëorigin frames
      }
    };
  }

  function openLoadModal(options){
    if (!loadModal || !loadFrame) {
      return;
    }
    if (!loadBaseUrl) {
      alert('Impossibile aprire il caricamento per questo box.');
      return;
    }
    const params = new URLSearchParams();
    params.set('embedded', '1');
    params.set('box_id', '{{ box.id }}');
    if (options && options.itemId) {
      params.set('item_id', options.itemId);
    }
    if (options && options.autoSelect) {
      params.set('auto_select', '1');
    }
    attachLoadWatcher();
    loadFrame.src = loadBaseUrl + '?' + params.toString();
    loadModal.style.display = 'flex';
    loadModal.setAttribute('aria-hidden', 'false');
  }

  const btnOpenLoad = document.getElementById('btn-open-load');
  if (btnOpenLoad) {
    btnOpenLoad.addEventListener('click', function(){
      openLoadModal({ autoSelect: true });
    });
  }

  const btnCloseLoad = document.getElementById('btn-close-load');
  if (btnCloseLoad) {
    btnCloseLoad.addEventListener('click', function(){
      resetLoadModal();
    });
  }
  // For assembly and product boxes, open the build modal when the Costruisci button is clicked
  const btnBuild = document.getElementById('btn-open-build');
  if (btnBuild) {
    btnBuild.addEventListener('click', function(){
      const modal = document.getElementById('buildModal');
      const iframe = document.getElementById('buildFrame');
      if (modal && iframe) {
        // Determine the build URL from the data attribute on the button.
        const buildUrl = btnBuild.getAttribute('data-build-url');
        if (!buildUrl) return;
        iframe.src = buildUrl;
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        // When the iframe finishes loading, check whether it has navigated
        // away from the internal build pages (/inventory/build or
        // /inventory/build_product).  When the path is different we assume
        // the build has completed and reload the parent page.
        iframe.onload = function() {
          try {
            const loc = iframe.contentWindow.location;
            const href = loc && loc.href ? loc.href : '';
            const path = loc && loc.pathname ? loc.pathname : '';
            if (path && !path.startsWith('/inventory/build') && !path.startsWith('/inventory/build_product') && !(href.startsWith('about:'))) {
              iframe.onload = null;
              modal.style.display = 'none';
              modal.setAttribute('aria-hidden', 'true');
              iframe.src = '';
              alert('Costruzione completata con successo');
              window.location.reload();
            }
          } catch (err) {
            // Ignore cross-origin or other errors
          }
        };
      }
    });
  }
  // Close the build modal
  const btnCloseBuild = document.getElementById('btn-close-build');
  if (btnCloseBuild) {
    btnCloseBuild.addEventListener('click', function(){
      const modal = document.getElementById('buildModal');
      const iframe = document.getElementById('buildFrame');
      if (iframe) {
        iframe.onload = null;
        iframe.src = '';
      }
      if (modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
      }
    });
  }

  // -----------------------------------------------------------------------------
  // DataMatrix generation and download functionality
  // -----------------------------------------------------------------------------
  const dmContainers = document.querySelectorAll('.dm-container');
  dmContainers.forEach(function(container) {
    const code = container.getAttribute('data-code');
    if (code) {
      try {
        const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
        container.innerHTML = '';
        container.appendChild(svg);
      } catch (err) {
        console.error('Failed to generate DataMatrix for', code, err);
        container.textContent = code;
      }
    }
  });

  const perItemButtons = document.querySelectorAll('.load-item');
  if (perItemButtons && perItemButtons.length > 0) {
    perItemButtons.forEach(function(btn) {
      btn.addEventListener('click', function(evt) {
        evt.stopPropagation();
        const itemId = this.getAttribute('data-item-id');
        if (itemId) {
          openLoadModal({ itemId: itemId, autoSelect: true });
        }
      });
    });
  }

  // Convert an SVG element to a PNG data URL using a canvas.  The
  // returned promise resolves to a data URL representing the PNG.  This
  // helper is used when downloading the DataMatrix image.
  function svgToPngDataUrl(svgElement, size) {
    return new Promise(function(resolve, reject) {
      try {
        const svgString = new XMLSerializer().serializeToString(svgElement);
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        const canvas = document.createElement('canvas');
        const rect = svgElement.getBoundingClientRect();
        const width = size || rect.width || 120;
        const height = size || rect.height || 120;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);
          URL.revokeObjectURL(url);
          try {
            const pngData = canvas.toDataURL('image/png');
            resolve(pngData);
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = function(err) {
          URL.revokeObjectURL(url);
          reject(err);
        };
        img.src = url;
      } catch (err) {
        reject(err);
      }
    });
  }

  // Attach download handlers to each DataMatrix download button.  The
  // handler locates the sibling SVG, converts it to PNG and triggers a
  // download with a filename derived from the product code when available.
  const downloadButtons = document.querySelectorAll('.dm-download');
  if (downloadButtons && downloadButtons.length > 0) {
    downloadButtons.forEach(function(btn) {
      btn.addEventListener('click', function(evt) {
        evt.preventDefault();
        const row = btn.closest('tr');
        if (!row) return;
        const svg = row.querySelector('.dm-container svg');
        if (!svg) return;
        svgToPngDataUrl(svg, 240).then(function(dataUrl) {
          const link = document.createElement('a');
          const codeCell = row.querySelector('.production-box-item-code');
          const baseName = codeCell ? codeCell.textContent.trim() : 'datamatrix';
          link.href = dataUrl;
          link.download = baseName ? baseName + '-datamatrix.png' : 'datamatrix.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }).catch(function(err) {
          console.error('Unable to download DataMatrix', err);
          alert('Impossibile scaricare il Datamatrix.');
        });
      });
    });
  }

  // Nessun bottone extra duplicato: il pulsante "Carica documenti"
  // utilizza direttamente l'handler definito sopra.
});
</script>

