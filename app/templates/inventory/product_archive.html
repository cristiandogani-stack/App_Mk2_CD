{% extends 'base.html' %}

{#
  Archive view for a single product – component events only.

  This template displays a chronological list of scan events for all
  parts and commercial components associated with the selected product.
  Assemblies are excluded from this view and instead shown in the
  dedicated "Archivio assiemi".  A search input allows filtering by
  DataMatrix, component name or description.  Each row shows the
  timestamp, a small image of the DataMatrix code on a white
  background, the component name, description, user who performed the
  action, the action type and any attached documents.  Documents are
  presented as buttons linking to their static paths.
#}

{% block title %}Magazzino – {{ product.name }}: Archivio componenti{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}"
       class="btn ghost small back-link"
       data-module-back="fallback"
       data-fallback-url="{{ url_for('inventory.product_detail', product_id=product.id) }}">← Indietro</a>
    <div>
      <h2 class="page-title">Magazzino · {{ product.name }}</h2>
      <p class="page-subtitle">Archivio componenti e tracciabilità dei documenti caricati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.product_assemblies', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'assemblies' else ' ghost' }}">Assiemi</a>
      <a href="{{ url_for('inventory.product_parts', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'parts' else ' ghost' }}">Parti</a>
      <a href="{{ url_for('inventory.product_commercial', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'commercial' else ' ghost' }}">Commerciali</a>
      <a href="{{ url_for('inventory.product_archive_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Archivio&nbsp;componenti</a>
      <a href="{{ url_for('inventory.product_archive_assemblies_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive_assiemi' else ' ghost' }}">Archivio&nbsp;assiemi</a>
    </div>
    <div class="archive-search">
      <input type="search" id="product-archive-search" placeholder="Cerca evento..." aria-label="Cerca nell'archivio componenti">
    </div>
  </div>

  {% if events_data|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento registrato per questo prodotto.</p>
    </div>
  {% else %}
    <div id="product-archive-list" class="archive-grid" style="--archive-columns: 150px 160px minmax(180px,1.2fr) minmax(220px,1.5fr) 90px 160px minmax(150px,1fr);">
      <div class="archive-header">
        <span>Data/Ora</span>
        <span>DataMatrix</span>
        <span>Nome</span>
        <span>Descrizione</span>
        <span>Rev.</span>
        <span>Utente</span>
        <span>Docs</span>
      </div>
      {% for ev in events_data %}
        <div class="archive-row" data-archive-row>
          <div class="archive-cell" data-title="Data/Ora">
            {% if ev.timestamp %}
              <span class="cell-text">{{ ev.timestamp.strftime('%d/%m/%Y') }}</span>
              <span class="muted">{{ ev.timestamp.strftime('%H:%M') }}</span>
            {% else %}
              <span class="cell-text">—</span>
            {% endif %}
          </div>
          <div class="archive-cell" data-title="DataMatrix">
            <span class="dm-preview" data-code="{{ ev.datamatrix | e }}"></span>
            {% if ev.datamatrix %}<span class="muted" style="overflow-wrap:anywhere;">{{ ev.datamatrix }}</span>{% endif %}
          </div>
          <div class="archive-cell" data-title="Nome">
            <span class="cell-text">{{ ev.name }}</span>
          </div>
          <div class="archive-cell" data-title="Descrizione">
            <span class="cell-text" title="{{ ev.description if ev.description else '' }}">{{ ev.description if ev.description else '—' }}</span>
          </div>
          <div class="archive-cell" data-title="Rev.">
            <span class="cell-text">{{ ev.revision if ev.revision else '—' }}</span>
          </div>
          <div class="archive-cell" data-title="Utente">
            <span class="cell-text">{{ ev.user if ev.user else '—' }}</span>
          </div>
          <div class="archive-cell" data-title="Documenti">
            <div class="archive-docs">
              {% if ev.docs and ev.docs|length > 0 %}
                <a href="{{ url_for('inventory.product_event_docs_view', product_id=product.id, code=ev.datamatrix, ev_id=ev.id, src='components', stock_id=ev.stock_item_id) }}"
                   class="btn ghost small"
                   onclick="event.stopPropagation();">Docs</a>
              {% else %}
                <span class="btn ghost small disabled" title="Nessun documento" onclick="event.stopPropagation();">Docs</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('product-archive-search');
      const list = document.getElementById('product-archive-list');
      if (searchInput && list) {
        const rows = () => list.querySelectorAll('[data-archive-row]');
        searchInput.addEventListener('input', function () {
          const query = this.value.toLowerCase().trim();
          rows().forEach((row) => {
            const text = row.textContent.toLowerCase();
            row.style.display = (!query || text.includes(query)) ? '' : 'none';
          });
        });
      }

      const dmContainers = document.querySelectorAll('#product-archive-list .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.innerHTML = '';
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall through to plain-text rendering
          }
        }
        el.textContent = code;
      });
    });
  </script>
</section>
{% endblock %}