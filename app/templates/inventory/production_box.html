{% extends 'base.html' %}

{#
  Production box detail view.

  Lists all stock items contained within a production box along with
  their current status and a summary of associated documents.  When
  the box has not yet been completed a "Carica" button allows
  operators to finalise the loading process.  The actual state
  transition is performed via a call to the API endpoint
  ``/api/production-box/<id>/load`` from the client‑side JavaScript.
#}

{#
  Dynamically set the page title based on the current blueprint.  When this
  view is rendered within the production module, the title should read
  "Produzione" rather than "Magazzino" to reflect that the user is still
  in the production workflow.  Use the request endpoint to determine
  the blueprint name (e.g. "production" or "inventory").  Split the
  endpoint on the dot and compare the first segment.  Default to
  "Magazzino" for any unknown or inventory-related blueprints.
  See base.html for similar logic used to highlight the active module.
 #}
{% block title %}
  {%- set ep = request.endpoint or '' -%}
  {%- set bp = ep.split('.')|first -%}
  {%- set prefix = 'Produzione' if bp == 'production' else 'Magazzino' -%}
  {{ prefix }} – Box {{ box.code }}
{% endblock %}

{% block content %}
<section class="section">
  {#
    Replace the plain JavaScript history.back() on the back link with logic
    that reloads the referring page.  Using document.referrer ensures that
    the previous page is fetched anew from the server rather than being
    pulled from the browser's history cache.  When no referrer is available
    (e.g. the user navigated directly), fall back to history.back().
  #}
  <a href="#" class="btn ghost small" style="margin-bottom:8px;"
     onclick="if (document.referrer) { window.location.href = document.referrer; } else { window.history.back(); } return false;">← Indietro</a>
  {#
    Display the box header.  For assembly boxes show the component name
    (root_structure) as the title so that operators can identify what
    they are building.  Otherwise fall back to the box code.  Always
    show the current status beneath the title.
  #}
  <h2 class="section-title">
    {% if box.root_structure and box.root_structure.name %}
      {{ box.root_structure.name }}
    {% else %}
      Box di produzione: {{ box.code }}
    {% endif %}
  </h2>
  <p class="muted" style="margin-top:-8px;">Stato: {{ box.status }}</p>
  {% if box.stock_items|length == 0 %}
    <p class="muted">Il box è vuoto.</p>
  {% else %}
    <table class="table table-compact">
      <thead>
        <tr>
          <th>#</th>
          <th>DataMatrix</th>
          <th>Prodotto</th>
          <th>Stato</th>
          <!-- Header for download button column -->
          <th class="text-right"></th>
          {# Show an Actions column when lot management is disabled so operators can load items individually. #}
          {% if not box.lot_management and box.box_type not in ['ASSIEME', 'PRODOTTO'] %}
          <th>Azioni</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for item in box.stock_items %}
        {#
          Hide completed items while the box is still in progress (not COMPLETATO).
          When box.status is not COMPLETATO, skip rows whose item.status is COMPLETATO so
          that loaded parts disappear from the table.  Once the box is marked
          COMPLETATO, show all items for audit purposes.
        #}
        {% if box.status == 'COMPLETATO' or item.status != 'COMPLETATO' %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>
            <!-- Container for the generated DataMatrix SVG -->
            <div class="dm-container" data-code="{{ item.datamatrix_code | e }}" style="margin-bottom:4px; background:#fff; display:inline-block;"></div>
          </td>
          <td>{{ item.product.name }}</td>
          <td>{{ item.status }}</td>
          <!-- Separate cell for the download button aligned to the right -->
          <td class="text-right">
            <button class="btn small ghost dm-download">Scarica&nbsp;Datamatrix</button>
          </td>
          {% if not box.lot_management and box.box_type != 'ASSIEME' and box.status != 'COMPLETATO' %}
          <td>
            <button class="btn small primary load-item" data-item-id="{{ item.id }}">Carica</button>
          </td>
          {% endif %}
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
  {% if box.status != 'COMPLETATO' %}
    <div style="margin-top:16px;">
      {#
        Display a build button for both assembly and product boxes.  A box is
        considered buildable when its type is ASSIEME and it has either a
        valid assembly_id (for assemblies) or a product_id (for finished
        products).  The build button carries a data-build-url attribute
        pointing to the appropriate guided build endpoint.  For parts
        and commercial components (box.box_type != 'ASSIEME') the button
        remains a global "Carica" when lot management is enabled.
      #}
      {# Show the build button when the box represents an assembly or a finished product.
         Product boxes use the same guided build interface as assemblies, so
         include ``PRODOTTO`` in the allowed list.  When the box type is
         neither ASSIEME nor PRODOTTO, fall back to the load interface for
         parts and commercial items. #}
      {% if box.box_type in ['ASSIEME', 'PRODOTTO'] and (box.assembly_id or box.product_id) %}
        <button id="btn-open-build" class="btn primary"
                {% if box.assembly_id %}
                  data-build-url="{{ url_for('inventory.build_assembly', assembly_id=box.assembly_id) }}?embedded=1&box_id={{ box.id }}"
                {% elif box.product_id %}
                  data-build-url="{{ url_for('inventory.build_product', product_id=box.product_id) }}?embedded=1&box_id={{ box.id }}"
                {% endif %}
        >Costruisci</button>
      {% else %}
        {# For part/commercial boxes show a global Carica button only when
           lot management is enabled.  When lot management is disabled
           operators load each item individually using the per-row
           buttons in the table. #}
        {% if box.lot_management %}
        <button id="btn-open-load" class="btn primary">Carica</button>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}

  {# Modal for guided assembly build.
     An iframe loads the build_assembly page so that operators can
     upload documents and complete the checklist without leaving the
     production context.  The modal is hidden by default and shown
     when the "Costruisci" button is clicked.  A close button
     allows cancelling the build and returning to the box view.
  #}
  {% if box.box_type in ['ASSIEME', 'PRODOTTO'] and (box.assembly_id or box.product_id) %}
  <div id="buildModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; overflow:auto;">
    <div style="background:var(--glass-bg); margin:40px auto; padding:0; border-radius:16px; max-width:900px; width:95%; height:90vh; max-height:95vh; display:flex; flex-direction:column; overflow:hidden;">
      <div style="padding:16px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--glass-stroke);">
        <h3 style="margin:0; font-size:20px; font-weight:600;">
          Costruisci
          {% if box.root_structure and box.root_structure.name %}
            {{ box.root_structure.name }}
          {% elif box.product_name %}
            {{ box.product_name }}
          {% else %}
            
          {% endif %}
        </h3>
        <button id="btn-close-build" class="btn ghost small">Chiudi</button>
      </div>
      <iframe id="buildFrame" src="" style="flex:1 1 auto; border:none; width:100%; height:100%;"></iframe>
    </div>
  </div>
  {% endif %}

  {# Modal for loading parts/commercial boxes.
     Reworked to embed the load component page inside an iframe instead of
     rendering a separate form here.  The iframe loads the load_component
     endpoint in embedded mode and passes the production box identifier
     to allow the component to mark the box as completed.  This structure
     mirrors the assembly build modal to provide a consistent experience.
  #}
  {% if box.box_type not in ['ASSIEME', 'PRODOTTO'] %}
  <div id="loadModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; overflow:auto;">
    <div style="background:var(--glass-bg); margin:40px auto; padding:0; border-radius:16px; max-width:900px; width:95%; height:90vh; max-height:95vh; display:flex; flex-direction:column; overflow:hidden;">
      <div style="padding:16px; display:flex; justify-content:flex-end; align-items:center; border-bottom:1px solid var(--glass-stroke);">
        {# Removed the title from the load modal header to declutter the popup.
           Only the close button remains aligned to the right. #}
        <button id="btn-close-load" class="btn ghost small">Chiudi</button>
      </div>
      <iframe id="loadFrame" src="" style="flex:1 1 auto; border:none; width:100%; height:100%;"></iframe>
    </div>
  </div>
  {% endif %}
</section>

{# Load the client-side DataMatrix library.  This script defines a global
   `DATAMatrix` function which creates SVG elements representing the
   specified message.  The library must be loaded before the code
   below invokes `DATAMatrix` to render and download DataMatrix codes. #}
<script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // For part and commercial boxes, open the load modal and embed the
  // dedicated load component form when the "Carica" button is clicked.
  const btnOpenLoad = document.getElementById('btn-open-load');
  if (btnOpenLoad) {
    btnOpenLoad.addEventListener('click', function() {
      const modal = document.getElementById('loadModal');
      const iframe = document.getElementById('loadFrame');
      if (modal && iframe) {
        iframe.src = '/inventory/load/{{ box.root_structure.id }}?embedded=1&box_id={{ box.id }}';
        modal.style.display = 'block';
        // Monitor the iframe load event to detect when the form has redirected
        iframe.onload = function() {
          try {
            const loc = iframe.contentWindow.location;
            const href = loc && loc.href ? loc.href : '';
            const path = loc && loc.pathname ? loc.pathname : '';
            // If the iframe navigated away from the load page, treat it as completion
            if (path && !path.startsWith('/inventory/load') && !(href.startsWith('about:'))) {
              iframe.onload = null;
              modal.style.display = 'none';
              iframe.src = '';
              // Reload to reflect updated stock and box status
              window.location.reload();
            }
          } catch (err) {
            // Ignore errors caused by blank or cross‑origin frames
          }
        };
      }
    });
  }
  // Close the load modal and reset the iframe
  const btnCloseLoad = document.getElementById('btn-close-load');
  if (btnCloseLoad) {
    btnCloseLoad.addEventListener('click', function() {
      const modal = document.getElementById('loadModal');
      const iframe = document.getElementById('loadFrame');
      if (iframe) {
        iframe.onload = null;
        iframe.src = '';
      }
      if (modal) modal.style.display = 'none';
    });
  }
  // For assembly and product boxes, open the build modal when the Costruisci button is clicked
  const btnBuild = document.getElementById('btn-open-build');
  if (btnBuild) {
    btnBuild.addEventListener('click', function(){
      const modal = document.getElementById('buildModal');
      const iframe = document.getElementById('buildFrame');
      if (modal && iframe) {
        // Determine the build URL from the data attribute on the button.
        const buildUrl = btnBuild.getAttribute('data-build-url');
        if (!buildUrl) return;
        iframe.src = buildUrl;
        modal.style.display = 'block';
        // When the iframe finishes loading, check whether it has navigated
        // away from the internal build pages (/inventory/build or
        // /inventory/build_product).  When the path is different we assume
        // the build has completed and reload the parent page.
        iframe.onload = function() {
          try {
            const loc = iframe.contentWindow.location;
            const href = loc && loc.href ? loc.href : '';
            const path = loc && loc.pathname ? loc.pathname : '';
            if (path && !path.startsWith('/inventory/build') && !path.startsWith('/inventory/build_product') && !(href.startsWith('about:'))) {
              iframe.onload = null;
              modal.style.display = 'none';
              iframe.src = '';
              alert('Costruzione completata con successo');
              window.location.reload();
            }
          } catch (err) {
            // Ignore cross-origin or other errors
          }
        };
      }
    });
  }
  // Close the build modal
  const btnCloseBuild = document.getElementById('btn-close-build');
  if (btnCloseBuild) {
    btnCloseBuild.addEventListener('click', function(){
      const modal = document.getElementById('buildModal');
      const iframe = document.getElementById('buildFrame');
      if (iframe) {
        // Clear the iframe to release resources.  Detach any load
        // handler before resetting the src so that closing the modal
        // does not trigger the completion logic erroneously.
        iframe.onload = null;
        iframe.src = '';
      }
      if (modal) modal.style.display = 'none';
    });
  }

  // -----------------------------------------------------------------------------
  // DataMatrix generation and download functionality
  //
  // Each stock item row contains a `.dm-container` div with a `data-code`
  // attribute holding the DataMatrix payload, and a `.dm-download` button to
  // trigger downloading the DataMatrix as an image.  Use the global
  // `DATAMatrix` function to generate an SVG for each container.  Attach a
  // click handler to the download buttons that converts the SVG to a PNG
  // using a canvas and initiates a download.
  const dmContainers = document.querySelectorAll('.dm-container');
  dmContainers.forEach(function(container) {
    const code = container.getAttribute('data-code');
    if (code) {
      try {
        // Generate an SVG element for the DataMatrix.  Specify a
        // reasonable dimension so that the code is legible; the library
        // automatically scales the viewBox accordingly.  The
        // `DATAMatrix` function returns an SVG element.
        // Generate with smaller dimensions (half size) and white background
        const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
        // Clear any previous contents and append the generated SVG.
        container.innerHTML = '';
        container.appendChild(svg);
      } catch (err) {
        console.error('Failed to generate DataMatrix for', code, err);
        // As a fallback, show the code as plain text.
        container.textContent = code;
      }
    }
  });

  // When lot management is disabled, each stock item provides its own
  // "Carica" button.  Attach handlers to these buttons to open the
  // load modal for the corresponding item.  Pass the item id as a
  // query parameter so that the API can mark individual items as
  // completed.  Prevent the event from bubbling to the row click
  // handler (which navigates back to the list) by calling
  // stopPropagation().
  const perItemButtons = document.querySelectorAll('.load-item');
  if (perItemButtons && perItemButtons.length > 0) {
    perItemButtons.forEach(function(btn) {
      btn.addEventListener('click', function(evt) {
        evt.stopPropagation();
        const itemId = this.getAttribute('data-item-id');
        const modal = document.getElementById('loadModal');
        const iframe = document.getElementById('loadFrame');
        if (modal && iframe && itemId) {
          iframe.src = '/inventory/load/{{ box.root_structure.id }}?embedded=1&box_id={{ box.id }}&item_id=' + encodeURIComponent(itemId);
          modal.style.display = 'block';
          iframe.onload = function() {
            try {
              const loc = iframe.contentWindow.location;
              const href = loc && loc.href ? loc.href : '';
              const path = loc && loc.pathname ? loc.pathname : '';
              // If the iframe navigated away from the load page, treat it as completion
              if (path && !path.startsWith('/inventory/load') && !(href.startsWith('about:'))) {
                iframe.onload = null;
                modal.style.display = 'none';
                iframe.src = '';
                // Reload to reflect updated stock and box status
                window.location.reload();
              }
            } catch (err) {
              // Ignore errors caused by blank or cross‑origin frames
            }
          };
        }
      });
    });
  }

  // Convert an SVG element to a PNG data URL using a canvas.  The
  // returned promise resolves to a data URL representing the PNG.  This
  // helper is used when downloading the DataMatrix image.
  function svgToPngDataUrl(svgElement, size) {
    return new Promise(function(resolve, reject) {
      try {
        const svgString = new XMLSerializer().serializeToString(svgElement);
        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        const canvas = document.createElement('canvas');
        // Use provided size or fall back to the element's bounding box
        // dimensions.  Without explicit sizing the canvas would default
        // to 300x150 which distorts the DataMatrix.
        const rect = svgElement.getBoundingClientRect();
        const width = size || rect.width || 120;
        const height = size || rect.height || 120;
        canvas.width = width;
        canvas.height = height;
        img.onload = function() {
          const ctx = canvas.getContext('2d');
          // Clear any existing content
          ctx.clearRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0, width, height);
          URL.revokeObjectURL(url);
          try {
            const pngData = canvas.toDataURL('image/png');
            resolve(pngData);
          } catch (err) {
            reject(err);
          }
        };
        img.onerror = function(err) {
          URL.revokeObjectURL(url);
          reject(err);
        };
        img.src = url;
      } catch (err) {
        reject(err);
      }
    });
  }

  // Attach download functionality to each `.dm-download` button.  When
  // clicked, the corresponding DataMatrix SVG is converted to a PNG and
  // downloaded.  The button is expected to be placed immediately after
  // the `.dm-container` div in the markup; this handler locates the
  // container using `previousElementSibling`.  If no SVG is found the
  // code falls back to generating a new one from the data-code attribute.
  const downloadButtons = document.querySelectorAll('.dm-download');
  downloadButtons.forEach(function(btn) {
    btn.addEventListener('click', async function(ev) {
      ev.preventDefault();
      // The DataMatrix container is the element with class .dm-container within
      // the same table row as the clicked button.  Locate it using closest().
      const row = btn.closest('tr');
      const container = row ? row.querySelector('.dm-container') : null;
      if (!container) return;
      let svgEl = container.querySelector('svg');
      const code = container.getAttribute('data-code');
      if (!svgEl && code) {
        try {
          // Regenerate DataMatrix with the same size and white background for download
          svgEl = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
        } catch (err) {
          console.error('Error regenerating DataMatrix for download:', err);
        }
      }
      if (svgEl) {
        try {
          const dataUrl = await svgToPngDataUrl(svgEl);
          const link = document.createElement('a');
          link.href = dataUrl;
          link.download = (code || 'datamatrix') + '.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch (err) {
          console.error('Unable to convert DataMatrix to PNG:', err);
          alert('Impossibile generare l’immagine del DataMatrix');
        }
      }
    });
  });
});
</script>
{% endblock %}