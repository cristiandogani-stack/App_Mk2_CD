{% extends "base.html" %}
{% block content %}
<div class="container-lg">
    <h1 class="page-title">Magazzino Live</h1>
    <p class="mb-3">Elenco delle prenotazioni attive.</p>
    {% if not reservations %}
        <div class="alert alert-info">Non ci sono prenotazioni attive.</div>
    {% else %}
    <!-- Nasconde la vecchia tabella; verrà sostituita da un layout a schede -->
    <div class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle live-table">
            <thead>
                <tr>
                    <th class="text-nowrap">ID&nbsp;materiale</th>
                    <th class="text-nowrap">Tipo&nbsp;prenotazione</th>
                    <th class="text-nowrap">N°&nbsp;Bancale</th>
                    <th class="text-nowrap">Materiale</th>
                    <th class="text-nowrap">Spessore</th>
                    <!-- Nuove colonne per le dimensioni X e Y della lastra prenotata -->
                    <th class="text-nowrap">Dim&nbsp;X</th>
                    <th class="text-nowrap">Dim&nbsp;Y</th>
                    <th class="text-nowrap">Ubicazione</th>
                    <th class="text-nowrap">Macchina</th>
                    <th class="text-nowrap">Scadenza</th>
                    <th class="text-nowrap">Stato</th>
                    <th class="text-nowrap">Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reservations %}
                {#
                  Ogni riga contiene l'attributo data-due per calcolare
                  dinamicamente il semaforo in base alla differenza con l'ora
                  attuale.  La data è codificata in ISO 8601 per una facile
                  conversione in JavaScript.
                #}
                <tr data-due="{{ r.due.isoformat() }}" style="background-color: {{ r.color }};">
                    {#
                    Visualizza l'ID della prenotazione solo se la prenotazione è specifica.
                    Per le prenotazioni generiche l'ID viene nascosto, mostrando un trattino per
                    mantenere l'allineamento della tabella.
                    #}
                    <td>{% if not r.is_generic %}{{ r.id }}{% else %}—{% endif %}</td>
                    <td>{% if r.is_generic %}Generica{% else %}Specifica{% endif %}</td>
                    {# Colonna N°Bancale: mostra l'ID del bancale se disponibile, altrimenti un trattino #}
                    <td>{% if r.bancale_id %}{{ r.bancale_id }}{% else %}&mdash;{% endif %}</td>
                    <td data-bs-toggle="tooltip" data-bs-placement="top" title="{{ r.note if r.note else '' }}">{{ r.materiale }}</td>
                    <td>{{ r.spessore if r.spessore else '--' }}</td>
                    <td>{{ r.dimensione_x if r.dimensione_x else '--' }}</td>
                    <td>{{ r.dimensione_y if r.dimensione_y else '--' }}</td>
                    <td>{{ r.ubicazione_lettera }}-{{ r.ubicazione_numero }}</td>
                    <td>{{ r.macchina_nome if r.macchina_nome else '--' }}</td>
                    <td>{{ r.due.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td class="text-center">
                        <span class="semaforo"></span>
                    </td>
                    <td>
                        {# Mostra il pulsante di cancellazione prenotazione solo agli utenti
                           che dispongono della scheda "Anagrafiche articoli" (config).  Se
                           l'utente non possiede questo permesso la colonna resta
                           vuota. #}
                        {% if 'config' in session.get('allowed_tabs', []) %}
                        <form method="post" action="{{ url_for('delete_prenotazione', pren_id=r.pren_id) }}" onsubmit="return confirm('Eliminare questa prenotazione?');">
                            <button type="submit" class="btn btn-sm btn-danger">Cancella</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Nuovo layout a schede per le prenotazioni -->
    <div class="row g-3">
        {% for r in reservations %}
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card reservation-card" data-due="{{ r.due.isoformat() }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <!-- Left side: material name, spessore and dimensions -->
                        <div class="flex-grow-1" title="{{ r.note if r.note else '' }}">
                            <h5 class="card-title mb-1">{{ r.materiale }}</h5>
                            <p class="card-subtitle text-muted small mb-0">
                                {# Mostra il valore dello spessore con il prefisso "SP:".  Se assente, mostra "--" #}
                                SP: {{ r.spessore if r.spessore else '--' }}
                                {# Mostra le dimensioni se disponibili, separate da un punto #}
                                {% if r.dimensione_x or r.dimensione_y %}
                                • {{ r.dimensione_x if r.dimensione_x else '--' }}×{{ r.dimensione_y if r.dimensione_y else '--' }}
                                {% endif %}
                            </p>
                        </div>
                        <!-- Right side: ID (grande) e semaforo -->
                        <div class="d-flex flex-column align-items-end">
                            {% if not r.is_generic %}
                            <div class="reservation-id">{{ r.id }}</div>
                            {% endif %}
                            <span class="semaforo mt-1"></span>
                        </div>
                    </div>
                    <p class="mb-1"><strong>Tipo:</strong> {% if r.is_generic %}Generica{% else %}Specifica{% endif %}</p>
                    <p class="mb-1"><strong>Bancale:</strong> {% if r.bancale_id %}{{ r.bancale_id }}{% else %}&mdash;{% endif %}</p>
                    <p class="mb-1"><strong>Ubicazione:</strong> {{ r.ubicazione_lettera }}-{{ r.ubicazione_numero }}</p>
                    <p class="mb-1"><strong>Macchina:</strong> {{ r.macchina_nome if r.macchina_nome else '--' }}</p>
                    <p class="mb-1"><strong>Scadenza:</strong> {{ r.due.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% if 'config' in session.get('allowed_tabs', []) %}
                    <form method="post" action="{{ url_for('delete_prenotazione', pren_id=r.pren_id) }}" onsubmit="return confirm('Eliminare questa prenotazione?');" class="mt-2">
                        <button type="submit" class="btn btn-sm btn-danger w-100">Cancella</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# Sezione accettazione: mostra i materiali in attesa di accettazione con informazioni dettagliate #}
    {% if accettazioni and accettazioni|length > 0 %}
    <h2 class="section-title">Accettazione</h2>
    <!-- Nasconde la vecchia tabella delle accettazioni, sostituita da un layout a fisarmonica -->
    <div class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle live-table">
            <thead>
                <tr>
                    <th class="text-nowrap">Data</th>
                    <th class="text-nowrap">N°Ordine</th>
                    <th class="text-center text-nowrap">Materiale</th>
                    <th class="text-nowrap">Tipo</th>
                    <th class="text-nowrap">Spessore</th>
                    <th class="text-nowrap">Dim&nbsp;X</th>
                    <th class="text-nowrap">Dim&nbsp;Y</th>
                    <th class="text-nowrap">Q.tà&nbsp;totale</th>
                    <th class="text-nowrap">Q.tà&nbsp;ricevuta</th>
                    <th class="text-nowrap">Data&nbsp;prevista</th>
                    <th class="text-nowrap">Produttore</th>
                    <th class="text-nowrap">Fornitore</th>
                    <th class="text-nowrap">Stato</th>
                    <th class="text-nowrap">Azioni</th>
                </tr>
            </thead>
            <tbody>
                {% for a in accettazioni %}
                <tr>
                    <td>{{ a.data.split(' ')[0] if a.data else a.data }}</td>
                    <td>{{ a.numero_ordine if a.numero_ordine else '—' }}</td>
                    <td>{{ a.materiale }}</td>
                    <td>{{ a.tipo if a.tipo else '—' }}</td>
                    <td>{{ a.spessore if a.spessore else '—' }}</td>
                    <td>{{ a.dimensione_x if a.dimensione_x else '—' }}</td>
                    <td>{{ a.dimensione_y if a.dimensione_y else '—' }}</td>
                    <td>{{ a.quantita_totale }}</td>
                    <td>{{ a.quantita_ricevuta }}</td>
                    <td>{{ a.data_prevista if a.data_prevista else '—' }}</td>
                    <td>
                        {#
                            Visualizza sempre il produttore scelto per questa consegna come testo.
                            Non consentire la modifica del produttore in fase di accettazione live.
                            Si visualizza prima il produttore associato alla singola consegna
                            (campo ``a.produttore``); se non presente si utilizza
                            ``a.produttore_scelto`` proveniente dall'ordine.
                        #}
                        {% set prod_to_show = a.produttore if a.produttore else (a.produttore_scelto if a.produttore_scelto else None) %}
                        {{ prod_to_show if prod_to_show else '—' }}
                    </td>
                    <td>
                        {#
                            Visualizza sempre il fornitore scelto (se presente) come testo non modificabile.
                            Se il fornitore non è ancora stato scelto, ma l'elenco contiene un solo elemento,
                            mostra direttamente quell'unico nome.  Solo nel caso in cui non vi sia ancora
                            un fornitore selezionato e ci siano più opzioni disponibili, consenti la scelta
                            tramite select.  In questo modo l'accettazione riprende correttamente
                            il fornitore scelto nell'RDO e non permette più la modifica.
                            Per gli ordini manuali (senza lista fornitori), se la colonna
                            "fornitore" della riga di accettazione è valorizzata, visualizza
                            tale valore.
                        #}
                        {#
                            Mostra il fornitore in base alle seguenti priorità:
                            1. Se è stato scelto un fornitore tramite RDO (``fornitore_scelto``), visualizzarlo.
                            2. Se la riga di accettazione ha un fornitore esplicito (campo ``fornitore``), visualizzarlo anche se
                               l'elenco fornitori contiene più opzioni (caso di ordini manuali salvati con un fornitore).
                            3. Se non c'è fornitore scelto ma l'elenco dei fornitori contiene al massimo un elemento,
                               mostrare quell'unico nome se esiste, altrimenti lasciare un trattino.
                            4. Solo se non esiste alcun fornitore preimpostato e ci sono più opzioni disponibili,
                               consentire la selezione tramite una tendina.
                        #}
                        {% if a.fornitore_scelto %}
                            {{ a.fornitore_scelto }}
                        {% elif a.fornitore %}
                            {{ a.fornitore }}
                        {% elif a.fornitori|length <= 1 %}
                            {% if a.fornitori %}
                                {{ a.fornitori[0] }}
                            {% else %}
                                —
                            {% endif %}
                        {% else %}
                            <select class="form-select form-select-sm forn-select" data-order="{{ a.numero_ordine }}">
                                <option value="" disabled selected>Seleziona...</option>
                                {% for f in a.fornitori %}
                                <option value="{{ f }}">{{ f }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{{ a.quantita_ricevuta }}/{{ a.quantita_totale }} accettati</span>
                            <div class="progress ms-2 flex-grow-1" style="width: 100%;">
                                <div class="progress-bar" role="progressbar" style="width: {{ a.progress_pct }}%" aria-valuenow="{{ a.progress_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <form class="d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center accept-form" method="POST" action="{{ url_for('accettazione_update', acc_id=a.id) }}">
                            <div class="d-flex gap-1 align-items-center">
                                <input type="number" name="quantita" id="quantita-live-{{ loop.index0 }}" class="form-control form-control-sm" min="1" max="{{ a.residuo }}" value="{{ a.residuo }}" style="width: 6rem;" />
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">Accetta</button>
                            <small class="form-text text-muted">Residuo: {{ a.residuo }}</small>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Nuovo layout a fisarmonica per le accettazioni -->
    <div class="accordion mt-3" id="acceptAccordion">
        {% for a in accettazioni %}
        <div class="accordion-item live-accept-item">
            <h2 class="accordion-header" id="acceptHeading{{ loop.index }}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#acceptCollapse{{ loop.index }}" aria-expanded="false" aria-controls="acceptCollapse{{ loop.index }}">
                    <div class="d-flex w-100 align-items-center">
                        <span class="fw-semibold flex-grow-1">{{ a.materiale }}</span>
                        <span class="badge bg-secondary">{{ a.numero_ordine if a.numero_ordine else '—' }}</span>
                    </div>
                    <div class="w-100 mt-1 text-center">
                        <span style="font-size:1rem; font-weight:600;">Arriva entro il: {{ a.data_prevista if a.data_prevista else '—' }}</span>
                    </div>
                </button>
            </h2>
            <div id="acceptCollapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="acceptHeading{{ loop.index }}" data-bs-parent="#acceptAccordion">
                <div class="accordion-body">
                    <div class="row g-3">
                        <div class="col-12 col-md-4">
                            <p class="mb-1"><strong>Tipo:</strong> {{ a.tipo if a.tipo else '—' }}</p>
                            <p class="mb-1"><strong>Spessore:</strong> {{ a.spessore if a.spessore else '—' }}</p>
                            <p class="mb-1"><strong>Dimensioni:</strong> {{ a.dimensione_x if a.dimensione_x else '—' }}×{{ a.dimensione_y if a.dimensione_y else '—' }}</p>
                            <p class="mb-1"><strong>Data prevista:</strong> {{ a.data_prevista if a.data_prevista else '—' }}</p>
                        </div>
                        <div class="col-12 col-md-4">
                            <p class="mb-1"><strong>Produttore:</strong> {% set prod_to_show = a.produttore if a.produttore else (a.produttore_scelto if a.produttore_scelto else None) %}{{ prod_to_show if prod_to_show else '—' }}</p>
                            <p class="mb-1"><strong>Fornitore:</strong>
                                {% if a.fornitore_scelto %}
                                    {{ a.fornitore_scelto }}
                                {% elif a.fornitore %}
                                    {{ a.fornitore }}
                                {% elif a.fornitori|length <= 1 %}
                                    {% if a.fornitori %}
                                        {{ a.fornitori[0] }}
                                    {% else %}
                                        —
                                    {% endif %}
                                {% else %}
                                    <select class="form-select form-select-sm forn-select" data-order="{{ a.numero_ordine }}">
                                        <option value="" disabled selected>Seleziona...</option>
                                        {% for f in a.fornitori %}
                                        <option value="{{ f }}">{{ f }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-12 col-md-4">
                            <p class="mb-1"><strong>Quantità:</strong> {{ a.quantita_ricevuta }}/{{ a.quantita_totale }} accettati</p>
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: {{ a.progress_pct }}%" aria-valuenow="{{ a.progress_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <form class="d-flex flex-column flex-sm-row gap-2 align-items-start align-items-sm-center accept-form" method="POST" action="{{ url_for('accettazione_update', acc_id=a.id) }}">
                                <div class="d-flex gap-1 align-items-center">
                                    <input type="number" name="quantita" id="quantita-live-{{ loop.index0 }}" class="form-control form-control-sm" min="1" max="{{ a.residuo }}" value="{{ a.residuo }}" style="width: 6rem;" />
                                </div>
                                <button type="submit" class="btn btn-primary btn-sm">Accetta</button>
                                <small class="form-text text-muted">Residuo: {{ a.residuo }}</small>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <a class="btn btn-secondary mt-3" href="{{ url_for('dashboard') }}">Dashboard</a>
</div>
<!-- Aggiorna automaticamente la pagina ogni 60 secondi per mostrare lo stato
     aggiornato delle prenotazioni.  Utilizziamo setTimeout anziché
     setInterval per evitare sovrapposizioni nel caso in cui il refresh
     sia lento.  L'utente può comunque navigare via il link in alto. -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Funzione che pianifica il refresh dopo 60 secondi solo se la
    // pagina è visibile.  In precedenza la pagina veniva ricaricata
    // indiscriminatamente ogni minuto, anche quando l'utente era su
    // un'altra tab.  Utilizziamo la Page Visibility API per
    // verificare che il documento non sia nascosto.  Se la pagina
    // torna visibile dopo essere stata in background, il refresh sarà
    // gestito tramite l'evento visibilitychange definito più avanti.
    setTimeout(function() {
      if (window.location.pathname.endsWith('/live') && !document.hidden) {
        window.location.reload();
      }
    }, 60000); // 60.000 ms = 60 secondi
  });
</script>

<!-- Collega al server SSE per ricevere notifiche in tempo reale quando vengono create o cancellate prenotazioni o quando viene aggiunto un nuovo ordine alla sezione di accettazione.  Quando viene ricevuto un evento ricarichiamo automaticamente la pagina se l'utente si trova ancora sulla vista Live. -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Verifica che il browser supporti EventSource (SSE)
  if (typeof EventSource !== 'undefined') {
    try {
      const es = new EventSource("{{ url_for('live_events') }}");
      es.onmessage = function(e) {
        // Ricarica la pagina solo se è visibile e l'utente si trova ancora su /live.
        if (window.location.pathname.endsWith('/live') && !document.hidden) {
          window.location.reload();
        }
      };
      es.onerror = function(err) {
        // Logga l'errore sulla console ma non interrompe l'esecuzione del resto della pagina
        console.error('Errore nella connessione SSE:', err);
      };
    } catch (err) {
      console.error('Impossibile inizializzare EventSource', err);
    }
  }
});
</script>

<!-- Gestisce l'evento visibilitychange per ricaricare la pagina Live quando torna visibile.
     Se l'utente naviga su un'altra tab o finestra, la proprietà document.hidden diventa true e
     il codice sopra evita di eseguire refresh.  Al ritorno sulla tab Live (document.hidden=false)
     forziamo un refresh immediato per recuperare eventuali aggiornamenti persi. -->
<script>
document.addEventListener('visibilitychange', function() {
  if (!document.hidden && window.location.pathname.endsWith('/live')) {
    // Ricarica la pagina una volta quando torna visibile
    window.location.reload();
  }
});
</script>

<!-- Calcola il colore del semaforo per ogni prenotazione in base alla scadenza -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const now = new Date();
  // Seleziona tutti gli elementi (righe o schede) che hanno l'attributo data-due
  document.querySelectorAll('[data-due]').forEach(function(el) {
    const dueStr = el.getAttribute('data-due');
    if (!dueStr) return;
    const dueDate = new Date(dueStr);
    const diffMinutes = (dueDate - now) / (1000 * 60);
    const semaforo = el.querySelector('.semaforo');
    if (!semaforo) return;
    let colorClass;
    if (diffMinutes >= 120) {
      colorClass = 'semaforo-green';
    } else if (diffMinutes >= 60) {
      colorClass = 'semaforo-yellow';
    } else {
      colorClass = 'semaforo-red';
    }
    semaforo.classList.add(colorClass);
    // Aggiorna il colore di sfondo o bordo in base al tipo di elemento
    if (colorClass === 'semaforo-green') {
      if (el.classList.contains('reservation-card')) {
        el.style.backgroundColor = '#e6f7e6';
      } else {
        el.style.backgroundColor = '#e6f7e6';
      }
    } else if (colorClass === 'semaforo-yellow') {
      if (el.classList.contains('reservation-card')) {
        el.style.backgroundColor = '#fffbea';
      } else {
        el.style.backgroundColor = '#fffbea';
      }
    } else {
      if (el.classList.contains('reservation-card')) {
        el.style.backgroundColor = '#fdeaea';
      } else {
        el.style.backgroundColor = '#fdeaea';
      }
    }
  });
});
</script>
<script>
// Gestione selezione fornitore nella vista live
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.forn-select').forEach(function(sel) {
    sel.addEventListener('change', function() {
      const orderNum = this.getAttribute('data-order');
      const selected = this.value;
      if (!orderNum || !selected) {
        return;
      }
      if (!confirm('Vuoi confermare il fornitore selezionato?')) {
        this.selectedIndex = 0;
        return;
      }
      fetch('{{ url_for("set_fornitore_ordine") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ numero_ordine: orderNum, fornitore: selected })
      }).then(function(response) { return response.json(); }).then(function(data) {
        if (data && data.success) {
          window.location.reload();
        } else {
          alert(data.error || data.message || 'Errore durante il salvataggio');
          sel.selectedIndex = 0;
        }
      }).catch(function() {
        alert('Errore di rete');
        sel.selectedIndex = 0;
      });
    });
  });
});
</script>
<script>
// Gestione selezione produttore nella vista live
// Aggiungiamo un event listener per gli elementi con classe `.prod-select`:
// quando l'utente seleziona un produttore dalla tendina, viene inviato
// un request JSON all'endpoint `set_produttore_ordine` per salvare la scelta.
// Se il salvataggio va a buon fine la pagina viene ricaricata, altrimenti
// viene mostrato un messaggio di errore e la selezione viene resettata.
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.prod-select').forEach(function(sel) {
    sel.addEventListener('change', function() {
      const orderNum = this.getAttribute('data-order');
      const selected = this.value;
      if (!orderNum || !selected) {
        return;
      }
      if (!confirm('Vuoi confermare il produttore selezionato?')) {
        this.selectedIndex = 0;
        return;
      }
      fetch('{{ url_for("set_produttore_ordine") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ numero_ordine: orderNum, produttore: selected })
      }).then(function(response) { return response.json(); }).then(function(data) {
        if (data && data.success) {
          window.location.reload();
        } else {
          alert(data.error || data.message || 'Errore durante il salvataggio');
          sel.selectedIndex = 0;
        }
      }).catch(function() {
        alert('Errore di rete');
        sel.selectedIndex = 0;
      });
    });
  });
});
</script>
<script>
//
// Gestione click sulle schede di prenotazione nella vista Magazzino Live
//
// Le card con classe `reservation-card` rappresentano le prenotazioni attive.
// Quando l'utente clicca su una di queste card, viene chiesto se desidera
// evadere la prenotazione mediante la scansione del codice QR.  Se
// l'utente conferma, la pagina viene reindirizzata all'endpoint
// `scan` dove potrà effettuare la scansione e, al termine,
// verrà riportato in Magazzino Live.  Se l'utente annulla, non
// succede nulla.  Questa gestione è stata aggiunta per rendere più
// intuitiva l'evasione delle prenotazioni direttamente dalla vista live.
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.reservation-card').forEach(function(card) {
    card.addEventListener('click', function(e) {
      // Se l'utente clicca su un elemento interattivo interno alla card
      // come il pulsante "Cancella" (che si trova all'interno di un form),
      // non dobbiamo interpretare il click come evasione della prenotazione.
      if (e.target.closest('form')) {
        return;
      }
      const conferma = confirm('Vuoi evadere questa prenotazione tramite scansione del QR?');
      if (conferma) {
        // Reindirizza alla pagina di scansione QR.  L'endpoint `scan`
        // non necessita di parametri per funzionare; la pagina di
        // scarico material accetterà la scansione e al termine
        // reindirizzerà nuovamente a Magazzino Live.
        window.location.href = "{{ url_for('scan') }}";
      }
    });
  });
});
</script>
{# Script accetta residuo rimosso #}
{% endblock %}