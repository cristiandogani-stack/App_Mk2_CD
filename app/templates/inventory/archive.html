{% extends 'base.html' %}

{#
  Global production history view.

  This template presents the complete list of finished product builds in
  the warehouse.  Each build is rendered as a collapsible row showing
  when it was created, its DataMatrix code, the product name,
  description, the operator who performed the build and any
  associated documents.  Expanding a row reveals the components
  consumed during the build.  Nested sub‑assemblies are displayed
  recursively so that operators can inspect the entire exploded bill
  of materials for every production event.
#}

{% block title %}Magazzino – Storico produzione{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.index') }}"
       class="btn ghost small back-link"
       data-fallback-url="{{ url_for('inventory.index') }}">← Indietro</a>
    <div class="page-heading-text">
      <h2 class="page-title">Magazzino · Storico produzione</h2>
      <p class="page-subtitle">Cronologia delle costruzioni con dettaglio dei componenti consumati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.index') }}"
         class="btn small{{ ' primary' if active_tab == 'products' else ' ghost' }}">Prodotti</a>
      <a href="{{ url_for('inventory.archive') }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Storico&nbsp;produzione</a>
    </div>
    <div class="archive-search">
      <input type="search" id="production-history-search" placeholder="Cerca evento..." aria-label="Cerca nello storico produzione">
    </div>
  </div>

  {% if assemblies|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento registrato.</p>
    </div>
  {% else %}
    <div class="archive-card">
      <div id="production-history" class="archive-accordion-list" style="--archive-columns: 130px 80px 120px minmax(190px,1.1fr) minmax(240px,1.5fr) 80px 150px 120px;">
        <div class="archive-legend">
          <span>Data</span>
          <span>Ora</span>
          <span>DataMatrix</span>
          <span>Nome</span>
          <span>Descrizione</span>
          <span>Rev.</span>
          <span>Utente</span>
          <span>Docs</span>
        </div>
        {% macro render_node(node, depth=0) %}
          {% set has_children = node.components is defined and node.components|length > 0 %}
          {% if has_children %}
            <details class="archive-accordion" style="--depth: {{ depth }};" data-has-children="true">
              <summary class="accordion-summary">
                <span class="summary-cell" data-label="Data">
                  {% if node.timestamp %}
                    {{ node.timestamp.strftime('%d/%m/%Y') }}
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span class="summary-cell" data-label="Ora">
                  {% if node.timestamp %}
                    {{ node.timestamp.strftime('%H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span class="summary-cell dm-cell" data-label="DataMatrix">
                  <span class="dm-preview" data-code="{{ node.datamatrix | e }}" aria-hidden="true"></span>
                  {% if node.datamatrix %}<span class="sr-only">DataMatrix {{ node.datamatrix }}</span>{% endif %}
                </span>
                <span class="summary-cell" data-label="Nome">{{ node.name }}</span>
                <span class="summary-cell" data-label="Descrizione" title="{{ node.description if node.description else '' }}">{{ node.description if node.description else '—' }}</span>
                <span class="summary-cell" data-label="Rev.">{{ node.revision if node.revision else '—' }}</span>
                <span class="summary-cell" data-label="Utente">{{ node.user if node.user else '—' }}</span>
                <span class="summary-cell docs-cell" data-label="Docs">
                  {% if node.product_id and node.datamatrix %}
                    {% set docs_list = node.docs | default([], true) %}
                    {% set has_docs = docs_list|length > 0 %}
                    <a href="{{ url_for('inventory.product_docs_view', product_id=node.product_id, code=node.datamatrix, src='archive', box_id=node.box_id) }}"
                       class="btn ghost small"
                       data-empty-docs="{{ 'false' if has_docs else 'true' }}"
                       title="{{ 'Apri documenti' if has_docs else 'Nessun documento caricato – apri per scaricare il DataMatrix' }}"
                       onclick="event.stopPropagation();">Docs</a>
                  {% else %}
                    <span class="btn ghost small disabled" title="Documenti non disponibili" onclick="event.stopPropagation();">Docs</span>
                  {% endif %}
                </span>
              </summary>
              <div class="accordion-body" style="--depth: {{ depth + 1 }};">
                {% for child in node.components %}
                  {{ render_node(child, depth + 1) }}
                {% endfor %}
              </div>
            </details>
          {% else %}
            <div class="archive-leaf-row" data-archive-row style="--depth: {{ depth }};">
              <span class="summary-cell" data-label="Data">
                {% if node.timestamp %}
                  {{ node.timestamp.strftime('%d/%m/%Y') }}
                {% else %}
                  —
                {% endif %}
              </span>
              <span class="summary-cell" data-label="Ora">
                {% if node.timestamp %}
                  {{ node.timestamp.strftime('%H:%M') }}
                {% else %}
                  —
                {% endif %}
              </span>
              <span class="summary-cell dm-cell" data-label="DataMatrix">
                <span class="dm-preview" data-code="{{ node.datamatrix | e }}" aria-hidden="true"></span>
                {% if node.datamatrix %}<span class="sr-only">DataMatrix {{ node.datamatrix }}</span>{% endif %}
              </span>
              <span class="summary-cell" data-label="Nome">{{ node.name }}</span>
              <span class="summary-cell" data-label="Descrizione" title="{{ node.description if node.description else '' }}">{{ node.description if node.description else '—' }}</span>
              <span class="summary-cell" data-label="Rev.">{{ node.revision if node.revision else '—' }}</span>
              <span class="summary-cell" data-label="Utente">{{ node.user if node.user else '—' }}</span>
              <span class="summary-cell docs-cell" data-label="Docs">
                {% if node.product_id and node.datamatrix %}
                  {% set docs_list = node.docs | default([], true) %}
                  {% set has_docs = docs_list|length > 0 %}
                  <a href="{{ url_for('inventory.product_docs_view', product_id=node.product_id, code=node.datamatrix, src='archive', box_id=node.box_id) }}"
                     class="btn ghost small"
                     data-empty-docs="{{ 'false' if has_docs else 'true' }}"
                     title="{{ 'Apri documenti' if has_docs else 'Nessun documento caricato – apri per scaricare il DataMatrix' }}"
                     onclick="event.stopPropagation();">Docs</a>
                {% else %}
                  <span class="btn ghost small disabled" title="Documenti non disponibili" onclick="event.stopPropagation();">Docs</span>
                {% endif %}
              </span>
            </div>
          {% endif %}
        {% endmacro %}

        {% for asm in assemblies %}
          {{ render_node(asm) }}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('production-history-search');
      const container = document.getElementById('production-history');

      if (searchInput && container) {
        const leafRows = () => container.querySelectorAll('.archive-leaf-row[data-archive-row]');
        const detailNodes = () => container.querySelectorAll('details.archive-accordion');

        const applyFilter = (value) => {
          const query = value.toLowerCase().trim();
          if (!query) {
            leafRows().forEach((row) => {
              row.style.display = '';
            });
            detailNodes().forEach((node) => {
              node.style.display = '';
              node.open = false;
            });
            return;
          }

          leafRows().forEach((row) => {
            const match = row.textContent.toLowerCase().includes(query);
            row.style.display = match ? '' : 'none';
          });

          Array.from(detailNodes()).reverse().forEach((node) => {
            const summary = node.querySelector(':scope > summary');
            const summaryMatch = summary ? summary.textContent.toLowerCase().includes(query) : false;
            const children = node.querySelectorAll(':scope > .accordion-body > *');
            let childVisible = false;
            children.forEach((child) => {
              if (child.style.display !== 'none') {
                childVisible = true;
              }
            });
            const shouldShow = summaryMatch || childVisible;
            node.style.display = shouldShow ? '' : 'none';
            node.open = shouldShow && !!query;
            if (!shouldShow) {
              node.open = false;
            }
          });
        };

        searchInput.addEventListener('input', function () {
          applyFilter(this.value);
        });
      }

      const dmContainers = document.querySelectorAll('#production-history .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        el.innerHTML = '';
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall back to placeholder rendering below
          }
        }
        el.classList.add('dm-preview--fallback');
      });
    });
  </script>
</section>
{% endblock %}
