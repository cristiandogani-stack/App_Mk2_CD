{% extends 'base.html' %}

{#
  Production box detail view.

  Lists all stock items contained within a production box along with
  their current status and a summary of associated documents.  When
  the box has not yet been completed operators can either load
  outstanding components or launch the guided build workflow for
  assemblies and finished products.
#}

{% block title %}
  {%- set ep = request.endpoint or '' -%}
  {%- set bp = ep.split('.')|first -%}
  {%- set prefix = 'Produzione' if bp == 'production' else 'Magazzino' -%}
  {%- set hero_title = (box.root_structure.name if box.root_structure and box.root_structure.name else (box.product_name if box.product_name else 'Produzione')) -%}
  {{ prefix }} â€“ {{ hero_title }}
{% endblock %}

{% block content %}
{% set is_completed = (box.status == 'COMPLETATO') %}
{% set allow_build = (not is_completed and box.box_type in ['ASSIEME', 'PRODOTTO'] and (box.assembly_id or box.product_id)) %}
{% set allow_load = (not is_completed and box.box_type not in ['ASSIEME', 'PRODOTTO'] and box.lot_management) %}
{% set show_row_actions = (not box.lot_management and box.box_type not in ['ASSIEME', 'PRODOTTO'] and not is_completed) %}
{% set load_base_url = url_for('inventory.load_component', part_id=box.root_structure.id) if box.root_structure else None %}
{% set origin_url = url_for('production.index') %}
{% set hero_label = 'Assieme' if box.box_type == 'ASSIEME' else 'Prodotto' if box.box_type == 'PRODOTTO' else 'Commerciale' if box.box_type == 'COMMERCIALE' else 'Componenti' %}
{% set hero_name = box.root_structure.name if box.root_structure and box.root_structure.name else (box.product_name if box.product_name else 'Produzione') %}
{% set total_items = box.stock_items|length %}
{% set loaded_items = box.stock_items|selectattr('status', 'equalto', 'COMPLETATO')|list|length %}
{% set pending_items = total_items - loaded_items %}
{% if is_completed %}
{%   set visible_items = box.stock_items %}
{% else %}
{%   set visible_items = box.stock_items|rejectattr('status', 'equalto', 'COMPLETATO')|list %}
{% endif %}

<section class="section workflow-section production-box-section"
         data-box-id="{{ box.id }}"
         data-load-base="{{ load_base_url or '' }}"
         data-back-url="{{ origin_url }}">
  <div class="glass workflow-container production-box-container">
    <div class="build-complete-overlay" data-build-complete-overlay hidden>
      <div class="build-complete-card">
        <div class="build-complete-icon" aria-hidden="true">âœ…</div>
        <h3 class="build-complete-title" data-build-complete-message>Costruzione completata</h3>
        <p class="build-complete-copy" data-build-complete-detail>Ti riportiamo all'area produzione.</p>
        <button type="button" class="btn primary" data-build-complete-dismiss>Esci</button>
      </div>
    </div>
    <div class="workflow-hero">
      <div class="workflow-hero-main">
        <div class="workflow-thumb production-box-thumb">
          {% set hero_item = box.root_structure %}
          {% if hero_item and hero_item.display_image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.display_image_filename) }}" alt="{{ hero_name }}">
          {% elif hero_item and hero_item.image_filename %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + hero_item.image_filename) }}" alt="{{ hero_name }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ hero_name }}" style="filter: invert(1); opacity:0.7;">
          {% endif %}
        </div>
        <div class="workflow-hero-copy">
          <span class="workflow-eyebrow">{{ hero_label }}</span>
          <h1 class="workflow-title">{{ hero_name }}</h1>
        </div>
      </div>
      <div class="workflow-hero-actions">
        <span class="workflow-indicator">{{ 'ðŸŸ¢ Pronto' if is_completed else 'ðŸ”´ In attesa' }}</span>
        <div class="workflow-hero-buttons">
          <a href="{{ origin_url }}" class="btn ghost small back-link" data-back-link>Esci</a>
        </div>
      </div>
    </div>
    <div class="production-box-body">
      <div class="production-box-summary">
        <div class="production-box-stat">
          <span class="production-box-stat-label">Totale componenti</span>
          <span class="production-box-stat-value">{{ total_items }}</span>
        </div>
        <div class="production-box-stat">
          <span class="production-box-stat-label">Caricati</span>
          <span class="production-box-stat-value">{{ loaded_items }}</span>
        </div>
        {% if not is_completed and pending_items > 0 %}
          <div class="production-box-stat">
            <span class="production-box-stat-label">In lavorazione</span>
            <span class="production-box-stat-value">{{ pending_items }}</span>
          </div>
        {% endif %}
      </div>

      {% if box.root_structure and not is_completed and box.box_type not in ['ASSIEME', 'PRODOTTO'] %}
        <form id="inline-load-form"
              class="workflow-block load-inline load-inline-form"
              method="post"
              enctype="multipart/form-data"
              data-lot-mode="{{ 'true' if box.lot_management else 'false' }}"
              action="{{ url_for('inventory.load_component', part_id=box.root_structure.id, box_id=box.id, back_url=url_for('inventory.production_box_view', box_id=box.id)) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="item_id" value="">
          <input type="hidden" name="quantity" value="1">
          <div class="workflow-block-header">
            <h4>Caricamento documenti</h4>
            <div class="load-status-pill" data-load-status>{{ 'ðŸŸ¢ Documenti pronti' if not box.load_docs_required else 'ðŸ”´ Documenti mancanti' }}</div>
          </div>
          <p class="muted" data-selection-helper>
            {% if box.lot_management %}
              I documenti caricati verranno applicati a tutti i componenti del lotto.
            {% else %}
              Seleziona un componente dalla tabella per associare i documenti caricati.
            {% endif %}
          </p>
          {% if box.load_doc_defs %}
            <div class="document-section inline-load-docs">
              {% for doc in box.load_doc_defs %}
                <div class="document-card" data-doc-required>
                  <div class="document-card-header">
                    <div class="document-card-titles">
                      <span class="document-card-title">{{ box.load_doc_label_map.get(doc.type, doc.display_name) }}</span>
                      {% if doc.filename %}
                        <span class="document-card-filename" title="{{ doc.filename }}">{{ doc.filename }}</span>
                      {% endif %}
                    </div>
                    <div class="document-card-meta">
                      <a href="{{ url_for('products.download_file', filename=doc.original_path) }}"
                         class="btn ghost small"
                         target="_blank"
                         download="{{ doc.filename or doc.field_name }}">Scarica</a>
                    </div>
                  </div>
                  <div class="document-card-body">
                    <input type="file"
                           class="file-input-hidden"
                           name="{{ doc.field_name }}"
                           id="loadField_{{ loop.index }}"
                           data-load-input
                           required>
                    <button type="button" class="btn small primary" data-load-trigger-button>Carica documento</button>
                    <span class="document-file-name" data-load-filename></span>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="muted" style="margin:0;">Nessuna documentazione richiesta per questo componente.</p>
          {% endif %}
          <div class="inline-load-footer">
            <button type="submit"
                    class="btn primary"
                    data-load-submit
                    {% if box.load_docs_required %}disabled{% endif %}>
              {{ 'Carica componenti' if box.lot_management else 'Carica componente' }}
            </button>
          </div>
        </form>
      {% endif %}

      {% if box.box_type not in ['ASSIEME', 'PRODOTTO'] %}
      <div class="workflow-block">
        <div class="workflow-block-header">
          <h4>Componenti</h4>
          {% if is_completed %}
            <span class="status-pill status-ready">Completato</span>
          {% else %}
            <span class="status-pill status-progress">In lavorazione</span>
          {% endif %}
        </div>
        {% if total_items == 0 %}
          <p class="muted" style="margin:0;">Nessun elemento presente.</p>
        {% elif visible_items|length == 0 %}
          <p class="muted" style="margin:0;">Tutti i componenti sono stati caricati.</p>
        {% else %}
          <div class="table-scroll">
            <table class="production-box-table">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col">DataMatrix</th>
                  <th scope="col">Elemento</th>
                  <th scope="col">Stato</th>
                  <th scope="col" class="text-right">Download</th>
                  {% if show_row_actions %}
                    <th scope="col" class="text-right">Azioni</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% set row = namespace(index=0) %}
                {% for item in visible_items %}
                  {% set row.index = row.index + 1 %}
                  {% set status_class = 'status-ready' if item.status == 'COMPLETATO' else 'status-progress' if item.status in ['IN_LAVORAZIONE', 'IN_PREPARAZIONE'] else 'status-pending' %}
                  <tr>
                    <td data-title="#">{{ row.index }}</td>
                    <td data-title="DataMatrix">
                      <div class="dm-container"
                           data-dm-code="{{ (item.datamatrix_payload or '') | e }}">
                        {% if item.datamatrix_image %}
                          <img src="data:image/png;base64,{{ item.datamatrix_image }}"
                               alt="Datamatrix {{ item.product.code or item.product.name }}"
                               loading="lazy"
                               class="dm-image dm-image-fallback"
                               data-dm-image="{{ item.datamatrix_image }}">
                        {% endif %}
                        {% if not item.datamatrix_image %}
                          {% if item.datamatrix_payload %}
                            <span class="dm-fallback" title="{{ item.datamatrix_payload }}">{{ item.datamatrix_payload }}</span>
                          {% else %}
                            <span class="dm-fallback muted">â€”</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </td>
                    <td data-title="Elemento">
                      <div class="production-box-item">
                        <span class="production-box-item-name">{{ item.product.name }}</span>
                        {% if item.product.code %}
                          <span class="production-box-item-code">{{ item.product.code }}</span>
                        {% endif %}
                      </div>
                    </td>
                    <td data-title="Stato">
                      <span class="status-pill {{ status_class }}">{{ item.status }}</span>
                    </td>
                    <td data-title="Download" class="text-right">
                      <button class="btn small ghost dm-download"
                              type="button"
                              data-dm-image="{{ item.datamatrix_image or '' }}"
                              data-dm-code="{{ (item.datamatrix_payload or '') | e }}"
                              data-base-name="{{ item.product.code or 'datamatrix' }}">Scarica&nbsp;Datamatrix</button>
                    </td>
                    {% if show_row_actions %}
                      <td data-title="Azioni" class="text-right">
                        <button class="btn small ghost select-item"
                                type="button"
                                data-item-id="{{ item.id }}"
                                data-item-label="{{ item.product.code or item.product.name or 'Componente' }}"
                                data-select-item>Seleziona</button>
                      </td>
                    {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
        {% endif %}
      </div>
      {% endif %}
      {% if allow_build %}
        <div class="workflow-block build-inline" id="build-inline-panel"
             {% if box.assembly_id %}
               data-build-url="{{ url_for('inventory.build_assembly', assembly_id=box.assembly_id) }}"
               data-build-type="assembly"
             {% elif box.product_id %}
               data-build-url="{{ url_for('inventory.build_product', product_id=box.product_id) }}"
               data-build-type="product"
             {% endif %}
             data-state="loading"
             data-box-id="{{ box.id }}">
          <div class="workflow-block-header">
            <h4>Procedura di costruzione</h4>
          </div>
          <div class="build-inline-body">
            <div class="build-inline-loader" role="status" aria-live="polite">
              <div class="workflow-spinner" role="presentation"></div>
              <p>Caricamento interfacciaâ€¦</p>
            </div>
            <div class="build-inline-fragment" data-build-container></div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script defer src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
{% endblock %}
