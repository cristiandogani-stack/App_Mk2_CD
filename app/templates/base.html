<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Argal{% endblock %}</title>
  <meta name="color-scheme" content="dark light">
  <script>
    (function(){
      try{
        var stored = localStorage.getItem('theme');
        if(stored && stored !== 'system'){
          document.documentElement.setAttribute('data-theme', stored);
          if(stored === 'light'){
            document.documentElement.style.colorScheme = 'light dark';
          }else if(stored === 'dark'){
            document.documentElement.style.colorScheme = 'dark light';
          }
        }else if(stored === 'system'){
          document.documentElement.removeAttribute('data-theme');
          document.documentElement.style.colorScheme = '';
        }
        var meta = document.querySelector('meta[name="color-scheme"]');
        if(meta){
          if(stored === 'light'){ meta.content = 'light dark'; }
          else if(stored === 'dark'){ meta.content = 'dark light'; }
          else if(stored === 'system'){ meta.content = 'dark light'; }
        }
      }catch(e){}
    })();
  </script>
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.svg') }}" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script defer src="{{ url_for('static', filename='js/main.js') }}"></script>
</head>
<body class="app-body">

  {# Hide the header when rendering in embedded mode (e.g. inside an iframe).
     The "embedded" variable can be passed from the view to suppress the
     navigation and header.  #}
  {% if current_user.is_authenticated and not embedded %}
  <header class="app-header">
    <div class="header-inner">
      <div class="brand">
        {# Updated logo to use the new PNG provided by the user and wrap it in a link
           to the dashboard.  Making the logo clickable allows users to
           quickly return to the main dashboard from anywhere in the app. #}
        <a href="{{ url_for('dashboard.index') }}" class="brand-link" aria-label="Vai alla dashboard">
          <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo">
        </a>
        {# Removed brand name to display only the logo #}
      </div>
      <nav class="nav-desktop" aria-label="Sezioni applicazione">
        {#
          Highlight the active top‑level module by comparing the blueprint
          portion of the current request endpoint with that of each module.
          Routes within a blueprint share the same prefix (e.g. ``inventory.*``),
          so checking just the prefix ensures the module remains active when
          navigating deeper into its subpages.  Without this logic the
          navigation bar would deselect "Magazzino" when visiting
          "/inventory/products", "/inventory/assemblies", etc.
          When a blueprint explicitly sets ``active_module`` (for example the
          production module when delegating to inventory views) use that value
          to force the highlight.
        #}
        {% set cur_ep = request.endpoint or '' %}
        {% set detected_bp = (cur_ep.split('.')|first) %}
        {% set forced_bp = None %}
        {% if active_module is defined and active_module %}
          {% set forced_bp = active_module %}
        {% elif g is defined and g.active_module is defined and g.active_module %}
          {% set forced_bp = g.active_module %}
        {% endif %}
        {% set cur_bp = forced_bp if forced_bp else detected_bp %}
        {% for m in enabled_modules %}
          {% set mod_bp = (m.endpoint.split('.')|first) %}
          {% set is_active = (mod_bp == cur_bp) %}
          {# Rename the top‑level "Prodotti" module to "Anagrafiche" when rendering the navigation.  This
             ensures the link label reflects the new terminology without
             modifying the underlying blueprint slug or database record. #}
          {% set display_name = 'Anagrafiche' if (m.slug == 'products' or m.name == 'Prodotti') else m.name %}
          <a class="nav-link{{ ' active' if is_active else '' }}" href="{{ url_for(m.endpoint) }}">{{ display_name }}</a>
        {% endfor %}
      </nav>
      {# The global search bar has been removed from the header.  Search
         functionality is now available within the product pages themselves. #}
      <div class="header-actions">
        <button class="theme-toggle" id="themeToggle" data-theme-button type="button" aria-label="Cambia tema">
          <span class="icon" aria-hidden="true"></span>
          <span class="label">Tema</span>
        </button>
        <a class="btn ghost" href="{{ url_for('auth.logout') }}">Esci</a>
      </div>
      <button class="hamburger" id="hamburger" aria-label="Apri menu">☰</button>
    </div>
  </header>

  {# Mobile navigation: hidden in embedded mode #}
  <nav class="nav-mobile glass" id="mobileMenu" {% if embedded %}style="display:none;"{% endif %}>
    {#
      Mobile navigation highlights the active module using the same
      blueprint matching logic as the desktop navigation.  This keeps
      the "Magazzino" tab highlighted when browsing its internal pages.
      Respect the ``active_module`` override when provided.
    #}
    {% set cur_ep = request.endpoint or '' %}
    {% set detected_bp = (cur_ep.split('.')|first) %}
    {% set forced_bp = None %}
    {% if active_module is defined and active_module %}
      {% set forced_bp = active_module %}
    {% elif g is defined and g.active_module is defined and g.active_module %}
      {% set forced_bp = g.active_module %}
    {% endif %}
    {% set cur_bp = forced_bp if forced_bp else detected_bp %}
    {% for m in enabled_modules %}
      {% set mod_bp = (m.endpoint.split('.')|first) %}
      {% set is_active = (mod_bp == cur_bp) %}
      {# As on desktop, rename the "Prodotti" module to "Anagrafiche" for the mobile navigation. #}
      {% set display_name = 'Anagrafiche' if (m.slug == 'products' or m.name == 'Prodotti') else m.name %}
      <a class="nav-link{{ ' active' if is_active else '' }}" href="{{ url_for(m.endpoint) }}">{{ display_name }}</a>
    {% endfor %}
    <button class="nav-link toggle" id="themeToggleMobile" data-theme-button type="button">
      <span class="icon" aria-hidden="true"></span>
      <span class="label">Tema</span>
    </button>
    <a class="nav-link" href="{{ url_for('auth.logout') }}">Esci</a>
  </nav>
  {% endif %}

  <main id="mainContent" class="page-content">
    {# Display flash messages from Flask.  Without this the user never sees success/error alerts #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-stack">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {#
    Preserve scroll position after stock updates.  When a user submits a
    form with the class "stock-update" (used for loading stock in the
    warehouse), the current scroll position and pathname are stored in
    sessionStorage.  After the page reloads, if the stored pathname
    matches the current pathname, the page scrolls back to the saved
    position.  This prevents the view from jumping to the top during
    stock updates.
  #}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const savedPos = sessionStorage.getItem('stockScrollPos');
      const savedUrl = sessionStorage.getItem('stockScrollUrl');
      if (savedPos !== null && savedUrl === window.location.pathname) {
        // Use setTimeout to ensure scrolling after any automatic anchor jumps
        setTimeout(function() {
          window.scrollTo(0, parseInt(savedPos));
        }, 0);
        sessionStorage.removeItem('stockScrollPos');
        sessionStorage.removeItem('stockScrollUrl');
      }
    } catch (err) {
      // Ignore storage errors
    }
    // Attach scroll saving to forms marked as stock-update
    document.querySelectorAll('form.stock-update').forEach(function(form) {
      form.addEventListener('submit', function() {
        try {
          sessionStorage.setItem('stockScrollPos', window.pageYOffset.toString());
          sessionStorage.setItem('stockScrollUrl', window.location.pathname);
        } catch (err) {
          // Ignore storage errors
        }
      });
    });
  });
  </script>

  {# Hide footer when rendering in embedded mode so that modals do not display the
     application footer (for example inside production popups).  The embedded
     variable is passed via the view on pages that load within an iframe.  When
     embedded is true the footer is suppressed entirely. #}
  {% if not embedded %}
  <footer class="app-footer">
    <small>© {{ 2025 }} Argal Semiconductor</small>
  </footer>
  {% endif %}
</body>
</html>
