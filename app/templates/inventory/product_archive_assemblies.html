{% extends 'base.html' %}

{#
  Assemblies archive view for a single product.

  This template displays DataMatrix scan events corresponding to
  assemblies (T=ASSIEME) and their associated component events.  Each
  assembly event is rendered as a collapsible row; expanding the row
  reveals the component events linked to it via the ASSOCIA scan
  action.  The refreshed layout reuses the archive utility classes so
  that component, assembly and production histories share the same
  visual language.
#}

{% block title %}Magazzino – {{ product.name }}: Archivio assiemi{% endblock %}

{% block content %}
<section class="section archive-page">
  <div class="page-heading">
    <a href="{{ url_for('inventory.product_detail', product_id=product.id) }}"
       class="btn ghost small back-link"
       data-module-back="fallback"
       data-fallback-url="{{ url_for('inventory.product_detail', product_id=product.id) }}">← Indietro</a>
    <div class="page-heading-text">
      <h2 class="page-title">Magazzino · {{ product.name }}</h2>
      <p class="page-subtitle">Archivio assiemi e componenti collegati.</p>
    </div>
  </div>

  <div class="archive-toolbar">
    <div class="archive-tabs">
      <a href="{{ url_for('inventory.product_assemblies', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'assemblies' else ' ghost' }}">Assiemi</a>
      <a href="{{ url_for('inventory.product_parts', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'parts' else ' ghost' }}">Parti</a>
      <a href="{{ url_for('inventory.product_commercial', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'commercial' else ' ghost' }}">Commerciali</a>
      <a href="{{ url_for('inventory.product_archive_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive' else ' ghost' }}">Archivio&nbsp;componenti</a>
      <a href="{{ url_for('inventory.product_archive_assemblies_view', product_id=product.id) }}"
         class="btn small{{ ' primary' if active_tab == 'archive_assiemi' else ' ghost' }}">Archivio&nbsp;assiemi</a>
    </div>
    <div class="archive-search">
      <input type="search" id="assemblies-archive-search" placeholder="Cerca evento..." aria-label="Cerca nell'archivio assiemi">
    </div>
  </div>

  {% if assemblies|length == 0 %}
    <div class="archive-empty">
      <p class="muted">Nessun evento di assiemi registrato per questo prodotto.</p>
    </div>
  {% else %}
    <div class="archive-card">
      <div id="assemblies-archive" class="archive-accordion-list" style="--archive-columns: 130px 80px 120px minmax(190px,1.1fr) minmax(220px,1.4fr) 80px 150px 120px;">
        <div class="archive-legend">
          <span>Data</span>
          <span>Ora</span>
          <span>DataMatrix</span>
          <span>Nome</span>
          <span>Descrizione</span>
          <span>Rev.</span>
          <span>Utente</span>
          <span>Docs</span>
        </div>
        {% macro render_component(comp, depth=0) %}
          {% set has_children = comp.components is defined and comp.components|length > 0 %}
          {% if has_children %}
            <details class="archive-accordion" style="--depth: {{ depth }};" data-has-children="true">
              <summary class="accordion-summary">
                <span class="summary-cell" data-label="Data">
                  {% if comp.timestamp %}
                    {{ comp.timestamp.strftime('%d/%m/%Y') }}
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span class="summary-cell" data-label="Ora">
                  {% if comp.timestamp %}
                    {{ comp.timestamp.strftime('%H:%M') }}
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span class="summary-cell dm-cell" data-label="DataMatrix">
                  <span class="dm-preview" data-code="{{ comp.datamatrix | e }}" aria-hidden="true"></span>
                  {% if comp.datamatrix %}<span class="sr-only">DataMatrix {{ comp.datamatrix }}</span>{% endif %}
                </span>
                <span class="summary-cell" data-label="Nome">{{ comp.name }}</span>
                <span class="summary-cell" data-label="Descrizione" title="{{ comp.description if comp.description else '' }}">{{ comp.description if comp.description else '—' }}</span>
                <span class="summary-cell" data-label="Rev.">{{ comp.revision if comp.revision else '—' }}</span>
                <span class="summary-cell" data-label="Utente">{{ comp.user if comp.user else '—' }}</span>
                <span class="summary-cell docs-cell" data-label="Docs">
                  {% if comp.datamatrix %}
                    {% set docs_list = comp.docs | default([], true) %}
                    {% set has_docs = docs_list|length > 0 %}
                    <a href="{{ url_for('inventory.product_docs_view', product_id=product.id, code=comp.datamatrix, src='assemblies') }}"
                       class="btn ghost small"
                       data-empty-docs="{{ 'false' if has_docs else 'true' }}"
                       title="{{ 'Apri documenti' if has_docs else 'Nessun documento caricato – apri per scaricare il DataMatrix' }}"
                       onclick="event.stopPropagation();">Docs</a>
                  {% else %}
                    <span class="btn ghost small disabled" title="Documenti non disponibili" onclick="event.stopPropagation();">Docs</span>
                  {% endif %}
                </span>
              </summary>
              <div class="accordion-body" style="--depth: {{ depth + 1 }};">
                {% for child in comp.components %}
                  {{ render_component(child, depth + 1) }}
                {% endfor %}
              </div>
            </details>
          {% else %}
            <div class="archive-leaf-row" data-archive-row style="--depth: {{ depth }};">
              <span class="summary-cell" data-label="Data">
                {% if comp.timestamp %}
                  {{ comp.timestamp.strftime('%d/%m/%Y') }}
                {% else %}
                  —
                {% endif %}
              </span>
              <span class="summary-cell" data-label="Ora">
                {% if comp.timestamp %}
                  {{ comp.timestamp.strftime('%H:%M') }}
                {% else %}
                  —
                {% endif %}
              </span>
              <span class="summary-cell dm-cell" data-label="DataMatrix">
                <span class="dm-preview" data-code="{{ comp.datamatrix | e }}" aria-hidden="true"></span>
                {% if comp.datamatrix %}<span class="sr-only">DataMatrix {{ comp.datamatrix }}</span>{% endif %}
              </span>
              <span class="summary-cell" data-label="Nome">{{ comp.name }}</span>
              <span class="summary-cell" data-label="Descrizione" title="{{ comp.description if comp.description else '' }}">{{ comp.description if comp.description else '—' }}</span>
              <span class="summary-cell" data-label="Rev.">{{ comp.revision if comp.revision else '—' }}</span>
              <span class="summary-cell" data-label="Utente">{{ comp.user if comp.user else '—' }}</span>
              <span class="summary-cell docs-cell" data-label="Docs">
                {% if comp.datamatrix %}
                  {% set docs_list = comp.docs | default([], true) %}
                  {% set has_docs = docs_list|length > 0 %}
                  <a href="{{ url_for('inventory.product_docs_view', product_id=product.id, code=comp.datamatrix, src='assemblies') }}"
                     class="btn ghost small"
                     data-empty-docs="{{ 'false' if has_docs else 'true' }}"
                     title="{{ 'Apri documenti' if has_docs else 'Nessun documento caricato – apri per scaricare il DataMatrix' }}"
                     onclick="event.stopPropagation();">Docs</a>
                {% else %}
                  <span class="btn ghost small disabled" title="Documenti non disponibili" onclick="event.stopPropagation();">Docs</span>
                {% endif %}
              </span>
            </div>
          {% endif %}
        {% endmacro %}

        {% for asm in assemblies %}
          {{ render_component(asm) }}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <script src="{{ url_for('static', filename='js/datamatrix.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('assemblies-archive-search');
      const container = document.getElementById('assemblies-archive');

      if (searchInput && container) {
        const leafRows = () => container.querySelectorAll('.archive-leaf-row[data-archive-row]');
        const detailNodes = () => container.querySelectorAll('details.archive-accordion');

        const applyFilter = (value) => {
          const query = value.toLowerCase().trim();
          if (!query) {
            leafRows().forEach((row) => {
              row.style.display = '';
            });
            detailNodes().forEach((node) => {
              node.style.display = '';
              node.open = false;
            });
            return;
          }

          leafRows().forEach((row) => {
            const match = row.textContent.toLowerCase().includes(query);
            row.style.display = match ? '' : 'none';
          });

          Array.from(detailNodes()).reverse().forEach((node) => {
            const summary = node.querySelector(':scope > summary');
            const summaryMatch = summary ? summary.textContent.toLowerCase().includes(query) : false;
            const children = node.querySelectorAll(':scope > .accordion-body > *');
            let childVisible = false;
            children.forEach((child) => {
              if (child.style.display !== 'none') {
                childVisible = true;
              }
            });
            const shouldShow = summaryMatch || childVisible;
            node.style.display = shouldShow ? '' : 'none';
            node.open = shouldShow && !!query;
            if (!shouldShow) {
              node.open = false;
            }
          });
        };

        searchInput.addEventListener('input', function () {
          applyFilter(this.value);
        });
      }

      const dmContainers = document.querySelectorAll('#assemblies-archive .dm-preview[data-code]');
      const canRenderDM = typeof window.DATAMatrix === 'function';
      dmContainers.forEach((el) => {
        const code = el.getAttribute('data-code');
        if (!code) {
          return;
        }
        el.innerHTML = '';
        if (canRenderDM) {
          try {
            const svg = DATAMatrix({ msg: code, dim: 60, pad: 1, pal: ['#000', '#fff'] });
            el.appendChild(svg);
            return;
          } catch (err) {
            // fall back to placeholder rendering below
          }
        }
        el.classList.add('dm-preview--fallback');
      });
    });
  </script>
</section>
{% endblock %}
