{% extends 'base.html' %}

{#
  Guided procedure for building an assembly.

  This page lists the parts composing the selected assembly along with
  their current stock levels.  The user specifies how many assemblies
  should be produced and can upload documentation for each part (quality,
  manual, other).  When submitted the system decrements the stock
  quantities of the parts and increments the stock of the assembly.  A
  simple traffic light message indicates whether at least one unit can be
  built with the available stock.
#}

{% block title %}Costruisci {{ assembly.name }} â€“ Magazzino{% endblock %}

{% block content %}
{# When rendered in embedded mode (in a modal iframe), hide the site
   header, navigation and back link.  Apply custom styles to reduce
   distractions. #}
{% if embedded %}
<style>
  /* Hide header and mobile navigation completely */
  .app-header, .nav-mobile { display:none !important; }
  /* Hide the back link at the top of the build page */
  .back-link { display:none !important; }
</style>
<script>
// When embedded inside a modal, intercept the submit event of the build form.
// Ask for confirmation before proceeding.  If confirmed, allow the form
// to submit normally; after submission (a redirect), instruct the parent
// window to close the modal and refresh the page.  This prevents the
// "Annulla" link from being exposed and ensures a smooth workflow within
// the popup.
document.addEventListener('DOMContentLoaded', function(){
  const form = document.querySelector('form');
  if (!form) return;
  form.addEventListener('submit', function(e){
    // Confirmation prompt
    const ok = confirm('Confermare la costruzione dell\'assiemi?');
    if (!ok) {
      e.preventDefault();
      return;
    }
    // After submission, schedule closing the modal and reloading the parent
    // This timeout allows the POST request to complete before the parent
    // attempts to refresh (the backend will redirect).  Without the delay
    // the modal may close before the submission finalises.
    setTimeout(function(){
      if (window.parent) {
        try {
          const parentDoc = window.parent.document;
          const modal = parentDoc.getElementById('buildModal');
          const iframe = parentDoc.getElementById('buildFrame');
          if (iframe) iframe.src = '';
          if (modal) modal.style.display = 'none';
          // Refresh the parent page to reflect the new stock and box status
          window.parent.location.reload();
        } catch(err) {
          console.error(err);
        }
      }
    }, 1000);
  });
});
</script>
{# -------------------------------------------------------------------
   Dynamic update for document readiness in the build assembly form.

   The server provides ``ready_parts`` and ``assoc_ready`` flags for the
   assembly.  Traditionally the traffic light and build button only
   update after a full page reload, meaning operators do not see a
   green light until after submitting the build.  This script listens
   for changes on all file inputs in the form and updates the traffic
   light and build button in real time.  When every required document
   input has at least one file selected the indicator turns green.  The
   build button is enabled only when both the server-side conditions
   (parts in stock and components associated) are satisfied *and*
   all document fields have been filled.  This interactive feedback
   helps operators verify that all required uploads are complete before
   attempting to build the assembly. #}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.querySelector('form');
  if (!form) return;
  // Collect all file inputs in the document upload section.  These
  // correspond to the required documents for each part.  When no
  // documents are required the list may be empty.
  const fileInputs = form.querySelectorAll('input[type="file"]');
  // Locate the traffic light element displayed in the header.
  const semSpan = document.getElementById('assembly-status');
  // Reference the submit button.  It has type="submit" in the form.
  const buildBtn = form.querySelector('button[type="submit"]');
  // Determine the server-side readiness of parts and associations.  Use
  // JSON encoding so that true/false values are inserted literally.
  const readyParts = {{ ready_parts | tojson | safe }};
  const assocReady = {{ assoc_ready | tojson | safe }};
  function updateDocReady() {
    // If no file inputs exist, then no documentation is required and
    // the documents are inherently ready.
    let docsOk = (fileInputs.length === 0);
    // Otherwise ensure every input has a selected file.  Loop using
    // Array.from to handle the NodeList in older browsers.
    if (!docsOk) {
      docsOk = true;
      fileInputs.forEach(function(inp){
        if (!inp.files || inp.files.length === 0) {
          docsOk = false;
        }
      });
    }
    // Update the traffic light display.  Only update when the element
    // exists to avoid errors when the template changes.
    if (semSpan) {
      semSpan.textContent = docsOk && readyParts && assocReady ? 'ðŸŸ¢ Pronto' : 'ðŸ”´ In attesa';
    }
    // Enable or disable the build button.  The button is enabled only
    // when all conditions are satisfied.  If the build button is not
    // found (e.g. in read-only contexts) skip this step.
    if (buildBtn) {
      buildBtn.disabled = !(docsOk && readyParts && assocReady);
    }
  }
  // Attach change listeners to each file input to recalc readiness.
  fileInputs.forEach(function(inp) {
    inp.addEventListener('change', updateDocReady);
  });
  // Perform an initial update on page load.  This ensures the state is
  // consistent when the form is rendered from the server (for
  // example, when no documents are required).
  updateDocReady();
});
</script>
{% endif %}
<section class="section workflow-section">
  <div class="glass workflow-container">
    <div class="workflow-hero">
      <div class="workflow-hero-main">
        <div class="workflow-thumb">
          {% set asm_image = assembly.display_image_filename or assembly.image_filename %}
          {% if asm_image %}
            <img loading="lazy" src="{{ url_for('static', filename='uploads/' + asm_image) }}" alt="{{ assembly.name }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ assembly.name }}" style="filter:invert(1); opacity:0.7;">
          {% endif %}
        </div>
        <div class="workflow-hero-copy">
          <span class="workflow-eyebrow">Costruzione assieme</span>
          <h1 class="workflow-title">{{ assembly.name }}</h1>
          {% if assembly.description %}
            <p class="workflow-subtitle">{{ assembly.description }}</p>
          {% endif %}
        </div>
      </div>
      <div class="workflow-hero-actions">
        <span id="assembly-status" class="workflow-indicator" title="Stato lavorazione">
          {{ 'ðŸŸ¢ Pronto' if docs_ready and assoc_ready else 'ðŸ”´ In attesa' }}
        </span>
        <a href="{{ back_url or url_for('inventory.list_assemblies') }}" class="btn ghost small back-link">Indietro</a>
      </div>
    </div>
    <form method="post" enctype="multipart/form-data" class="workflow-form form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {# Preserve the URL to return to when the build is cancelled or completed.  This value is assigned in the view using
         request.referrer (or a fallback) and passed through the form as a hidden input so that the POST handler can
         redirect back to the correct location. #}
      <input type="hidden" name="back_url" value="{{ back_url or url_for('inventory.list_assemblies') }}">
      {% set asm_docs = required_docs.get(assembly.id, []) %}
      {% set doc_label_map = {
        'qualita': 'Modulo Cert. qualitÃ ',
        '3_1_materiale': '3.1 Materiale',
        'step_tavole': 'Step/tavola',
        'funzionamento': 'Verifica funzionamento',
        'istruzioni': 'Montaggio istruzioni',
        'ddt_fornitore': 'DDT fornitore',
        'altro': 'Altro'
      } %}
      <div class="workflow-body">
        <div class="workflow-main">
          <div class="workflow-block">
            <h4>Associa i componenti richiesti</h4>
            {% if parts|length > 0 %}
              <p class="muted" style="margin:0 0 12px;">Scansiona ogni componente per raggiungere il totale richiesto e abilita la costruzione.</p>
              <div class="grid grid-2 workflow-association-grid">
                {% for part in parts %}
                <div class="card glass workflow-association-card">
                  <div class="workflow-association-thumb">
                    {% if part.display_image_filename %}
                      <img loading="lazy" src="{{ url_for('static', filename='uploads/' + part.display_image_filename) }}" alt="{{ part.name }}">
                    {% else %}
                      <img loading="lazy" src="{{ url_for('static', filename='img/gear.svg') }}" alt="{{ part.name }}" style="filter: invert(1); opacity:0.7;">
                    {% endif %}
                  </div>
                  <h4 class="workflow-association-title">{{ part.name }}</h4>
                  <p class="workflow-association-meta">Richiesti: {{ required_quantities.get(part.id, 1) }}</p>
                  <p class="workflow-association-meta">Associati: {{ associated_counts.get(part.id, 0) }}</p>
                  <button type="button"
                          class="btn small primary associate"
                          data-part-id="{{ part.id }}"
                          data-part-name="{{ part.name }}"
                          data-required="{{ required_quantities.get(part.id, 1) }}"
                          data-associated="{{ associated_counts.get(part.id, 0) }}"
                          {% if (not assembly_code) or (associated_counts.get(part.id, 0) >= required_quantities.get(part.id, 1)) %}disabled{% endif %}>Associa</button>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted" style="margin:0;">Nessuna parte associata a questo assieme.</p>
            {% endif %}
          </div>
        </div>
        <aside class="workflow-side">
          <div class="workflow-block">
            <h4>Documenti assieme</h4>
            {% if asm_docs %}
              <div class="document-section">
                {% for doc in asm_docs %}
                <div class="document-card">
                  <div class="document-card-header">
                    <span class="document-card-title">{{ doc_label_map.get(doc.type, doc.type) }}</span>
                    <div class="document-card-meta">
                      {% if doc.original_filename %}
                        <a href="{{ url_for('products.download_file', filename=doc.original_filename) }}" target="_blank" class="btn ghost small" style="white-space:nowrap;">Scarica</a>
                      {% else %}
                        <span class="muted" style="white-space:nowrap;">â€”</span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="document-card-body">
                    <input type="file" name="{{ doc.field_name }}" required>
                    <span class="file-name document-file-name"></span>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="muted" style="margin:0;">Nessuna documentazione richiesta per l'assieme.</p>
            {% endif %}
          </div>
        </aside>
      </div>
      <div class="workflow-footer">
        {% if not embedded %}
          <a href="{{ back_url or url_for('inventory.list_assemblies') }}" class="btn ghost">Annulla</a>
        {% endif %}
        <button type="submit" class="btn primary" {% if not ready_all %}disabled{% endif %}>Costruisci</button>
      </div>
    </form>
  </div>
</section>
<script>
// Display selected file names next to each file input in the assembly build form
document.addEventListener('DOMContentLoaded', function(){
  // Delegate change event to the form to handle dynamic lists
  const form = document.querySelector('form');
  if (!form) return;
  form.addEventListener('change', function(e){
    const target = e.target;
    if (target && target.type === 'file') {
      const fileNameSpan = target.parentElement.querySelector('.file-name');
      if (fileNameSpan) {
        if (target.files && target.files.length > 0) {
          fileNameSpan.textContent = target.files[0].name;
        } else {
          fileNameSpan.textContent = '';
        }
      }
    }
  });
});
</script>
<script>
// Association workflow for linking produced components to the assembly
//
// Each "Associa" button triggers a prompt to scan or enter the DataMatrix
// code of the component.  The scanned code and the current assembly
// code are sent to the API endpoint ``/api/associate`` via a POST
// request.  Successful associations reload the page to update the
// associated counts and enable the build button when all components
// have been linked.  Errors are displayed in an alert.
document.addEventListener('DOMContentLoaded', function(){
  const assemblyCode = {{ assembly_code | tojson | safe }};
  const associateButtons = document.querySelectorAll('.associate');
  associateButtons.forEach(function(btn){
    btn.addEventListener('click', function(){
      // Validate that an assembly code is present.  Without a code
      // there is no context for association and the API will reject
      // the request.  Inform the operator early.
      if (!assemblyCode) {
        alert('Nessun codice assieme disponibile. Apri la costruzione da una prenotazione con scatola.');
        return;
      }
      const partName = this.dataset.partName || '';
      // Prompt for the DataMatrix code.  On physical terminals this
      // field will receive the scanned string from the scanner.  A
      // cancelled prompt aborts the operation.
      const scanned = prompt('Scansiona il datamatrix del componente ' + partName + ':');
      if (!scanned) {
        return;
      }
      // Parse the scanned DataMatrix to ensure the correct component is being associated.
      // Extract the value of the "P=" segment from the scanned code.  The DataMatrix
      // format is ``DMV1|P=<component>|S=...|T=...``.  Only allow association when
      // the scanned component matches the expected part name.  This prevents
      // accidentally linking a different component that may still belong to the
      // assembly but is not the one currently being processed.
      const trimmed = scanned.trim();
      let scannedPart = '';
      try {
        trimmed.split('|').forEach(function(seg){
          if (seg.startsWith('P=')) {
            scannedPart = seg.substring(2);
          }
        });
      } catch (err) {
        scannedPart = '';
      }
      if (scannedPart && scannedPart.toLowerCase() !== partName.toLowerCase()) {
        alert('Hai scansionato un componente errato.\nAtteso: ' + partName + '\nRilevato: ' + scannedPart);
        return;
      }
      // Prepare the payload for the API call
      const payload = {
        assembly_code: assemblyCode,
        component_code: trimmed
      };
      fetch('{{ url_for('api.associate_component') }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      }).then(function(response){
        return response.json();
      }).then(function(data){
        if (data && data.status === 'ok') {
          alert('Componente associato con successo.');
          // Reload to update counts and enable the build button when ready
          location.reload();
        } else {
          const msg = (data && data.error) ? data.error : 'Errore di associazione.';
          alert(msg);
        }
      }).catch(function(err){
        console.error(err);
        alert('Errore di rete durante l\'associazione.');
      });
    });
  });
});
</script>
{% endblock %}